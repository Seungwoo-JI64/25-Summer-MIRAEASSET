<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¯¸ë˜ì—ì…‹ íˆ¬ì ë¸Œë¦¬í•‘</title>
    <!-- Socket.IO í´ë¼ì´ì–¸íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Luxon ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ (Chart.js Date Adapter í•„ìš”) -->
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.x/build/global/luxon.min.js"></script>
    <!-- Chart.js Adapter Luxon (ì‹œê°„ ë°ì´í„° ì²˜ë¦¬ìš©) -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>
    <!-- Chart.js Annotation Plugin for news markers -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script>
    
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ - ì´ ë¶€ë¶„ì„ ë‹¹ì‹ ì˜ ì›ë˜ í”„ë¡œì íŠ¸ CSSë¡œ ëŒ€ì²´í•˜ì„¸ìš”. */
        body { font-family: 'Arial', sans-serif; margin: 20px; background-color: #f4f7f6; color: #333; line-height: 1.6;}
        .container { max-width: 900px; margin: auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        h1 { color: #0056b3; text-align: center; margin-bottom: 30px; }
        h2 { color: #0056b3; border-bottom: 2px solid #007bff; padding-bottom: 5px; margin-top: 40px; }
        h3 { color: #004085; margin-top: 25px; margin-bottom: 10px; font-size: 1.2em; }
        select, button { padding: 12px 20px; margin-right: 15px; border-radius: 5px; border: 1px solid #ddd; font-size: 1em; }
        button { background-color: #007bff; color: white; cursor: pointer; border: none; transition: background-color 0.3s ease; }
        button:hover { background-color: #0056b3; }
        #loading {
            display: none; /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ */
            flex-direction: column; /* ì„¸ë¡œ ì •ë ¬ */
            align-items: center; /* ê°€ìš´ë° ì •ë ¬ */
            margin-top: 25px;
            padding: 25px;
            background-color: #e6f7ff; /* ì—°í•œ íŒŒë€ìƒ‰ ë°°ê²½ */
            border: 1px solid #91d5ff;
            border-radius: 8px;
            text-align: center;
        }
        .spinner {
            border: 5px solid rgba(0, 0, 0, 0.1);
            border-left: 5px solid #007bff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #loading-message {
            font-size: 1.2em;
            font-weight: bold;
            color: #0056b3;
            margin-bottom: 8px;
        }
        #loading-explanation {
            font-size: 1em;
            color: #666;
            line-height: 1.5;
        }

        #results {
            margin-top: 30px;
            background-color: #f9f9f9;
            padding: 25px;
            border-radius: 8px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        .error-message-container {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background-color: #ffe6e6;
            border: 1px solid #ff9999;
            border-radius: 5px;
            color: #cc0000;
            font-weight: bold;
            text-align: center;
        }
        .report-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px dashed #eee;
        }
        .report-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .entity-card {
            background-color: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .entity-card h4 {
            color: #333;
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.1em;
            border-bottom: 1px dotted #ccc;
            padding-bottom: 5px;
        }
        .entity-card p {
            margin-bottom: 8px;
        }

        /* ì†ìµë¥  ìƒ‰ìƒ */
        .profit { color: #00a000; font-weight: bold; } /* ë…¹ìƒ‰ */
        .loss { color: #d00000; font-weight: bold; } /* ë¹¨ê°„ìƒ‰ */
        .neutral { color: #666; } /* íšŒìƒ‰ */
        .blue { color: #007bff; font-weight: bold; } /* íŒŒë€ìƒ‰ */

        /* í¬íŠ¸í´ë¦¬ì˜¤ ê°œìš” ìŠ¤íƒ€ì¼ */
        #portfolio-overview {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #eaf6ff;
            border: 1px solid #cce7ff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        #portfolio-overview h2 {
            text-align: center;
            color: #0056b3;
            margin-top: 0;
            margin-bottom: 20px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        #portfolio-overview table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        #portfolio-overview th, #portfolio-overview td {
            border: 1px solid #e0e0e0;
            padding: 10px;
            text-align: left;
        }
        #portfolio-overview th {
            background-color: #f0f8ff;
            color: #0056b3;
            font-weight: bold;
        }
        #portfolio-overview .total-summary p {
            margin: 5px 0;
            font-size: 1.1em;
            font-weight: bold;
        }

        /* ë‰´ìŠ¤ ìš”ì•½ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        #news-summary-section {
            margin-top: 40px;
            background-color: #f9f9f9;
            padding: 25px;
            border-radius: 8px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        .news-item {
            background-color: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 25px; /* <--- ìˆ˜ì •: ë‰´ìŠ¤ í•­ëª© ê°„ì˜ ê°„ê²© ì¦ê°€ (15px -> 25px) */
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .news-item h4 {
            margin-top: 0;
            margin-bottom: 10px;
        }
        .news-item h4 a {
            color: #0056b3;
            text-decoration: none;
            font-size: 1.1em;
        }
        .news-item h4 a:hover {
            text-decoration: underline;
        }
        .news-item p {
            font-size: 0.95em;
            color: #555;
        }
        .news-item .related-tickers span {
            display: inline-block;
            background-color: #e0f2f7;
            color: #0056b3;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 0.85em;
            margin-right: 5px;
            margin-bottom: 5px;
            cursor: pointer;
        }
        .news-item .related-tickers span:hover {
            background-color: #cce7ff;
        }
        
        /* ì£¼ì‹ ì •ë³´ íŒì—… (ëª¨ë‹¬) ìŠ¤íƒ€ì¼ */
        .stock-info-modal, .news-details-modal { /* ë‘ ëª¨ë‹¬ì— ê³µí†µ ìŠ¤íƒ€ì¼ ì ìš© */
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            display: flex; /* ì¤‘ì•™ ì •ë ¬ì„ ìœ„í•´ flex ì‚¬ìš© */
            justify-content: center; /* ìˆ˜í‰ ì¤‘ì•™ ì •ë ¬ */
            align-items: center; /* ìˆ˜ì§ ì¤‘ì•™ ì •ë ¬ */
        }
        .stock-info-modal-content, .news-details-modal-content { /* ë‘ ëª¨ë‹¬ ì½˜í…ì¸ ì— ê³µí†µ ìŠ¤íƒ€ì¼ ì ìš© */
            background-color: #fefefe;
            padding: 20px;
            border: 1px solid #888;
            border-radius: 8px;
            width: 90%; /* í™”ë©´ í¬ê¸°ì— ë”°ë¼ ì¡°ì ˆ */
            max-width: 600px; /* ë‰´ìŠ¤ ëª¨ë‹¬ì€ ì¡°ê¸ˆ ë” ë„“ê²Œ */
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            position: relative;
        }
        .stock-info-modal-content .close-button, .news-details-modal-content .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .stock-info-modal-content .close-button:hover,
        .stock-info-modal-content .close-button:focus,
        .news-details-modal-content .close-button:hover,
        .news-details-modal-content .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .stock-info-modal-content h3, .news-details-modal-content h3 {
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-top: 0;
        }
        .stock-info-modal-content p, .news-details-modal-content p {
            margin: 8px 0;
        }

        .news-modal-item {
            background-color: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
        }
        .news-modal-item h4 {
            margin-top: 0;
            margin-bottom: 5px;
            font-size: 1em;
        }
        .news-modal-item h4 a {
            color: #0056b3;
            text-decoration: none;
        }
        .news-modal-item p {
            font-size: 0.85em;
            color: #555;
        }


        /* ë¶„ì„ ê²°ê³¼ ì»¨í…Œì´ë„ˆ (ìƒˆë¡œ ì¶”ê°€) */
        #analysis-output-container {
            display: none; /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ */
            position: relative; /* ìì‹ ìš”ì†Œì˜ absolute ìœ„ì¹˜ ì§€ì •ì„ ìœ„í•¨ */
            margin-top: 30px;
            padding-top: 20px; /* ë‹«ê¸° ë²„íŠ¼ì„ ìœ„í•´ ìƒë‹¨ íŒ¨ë”© ì¶”ê°€ */
            border-radius: 8px;
            background-color: #fff; /* ì»¨í…Œì´ë„ˆ ë°°ê²½ìƒ‰ */
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* ì»¨í…Œì´ë„ˆ ê·¸ë¦¼ì */
        }

        /* ë‹«ê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .close-analysis-button {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 2em; /* í¬ê²Œ ë§Œë“¦ */
            color: #aaa;
            cursor: pointer;
            z-index: 10; /* ë‹¤ë¥¸ ìš”ì†Œ ìœ„ì— ì˜¤ë„ë¡ */
            line-height: 0.8; /* ì„¸ë¡œ ì •ë ¬ ë¯¸ì„¸ ì¡°ì • */
            padding: 5px; /* í´ë¦­ ì˜ì—­ í™•ëŒ€ */
        }
        .close-analysis-button:hover {
            color: #333;
        }

        /* ìƒˆë¡­ê²Œ ì¶”ê°€ëœ ì‹œì¥ ë°ì´í„° ì‹œê°í™” ì„¹ì…˜ */
        #market-data-visualization-section {
            display: none; /* ë¶„ì„ ì™„ë£Œ ì‹œ í‘œì‹œ */
            margin-top: 40px;
            background-color: #f9f9f9;
            padding: 25px;
            border-radius: 8px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        #market-data-visualization-section h2 {
            margin-bottom: 20px;
        }
        .ticker-chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); /* ë” ì´˜ì´˜í•˜ê²Œ */
            gap: 10px;
            margin-bottom: 25px;
        }
        .ticker-chart-block {
            background-color: #e8f0fe; /* Light blue */
            border: 1px solid #a8c7fa;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            font-weight: bold;
            font-size: 0.95em;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            white-space: nowrap; /* í‹°ì»¤ê°€ ì¤„ë°”ê¿ˆë˜ì§€ ì•Šë„ë¡ */
        }
        .ticker-chart-block:hover {
            background-color: #cddcfc;
            transform: translateY(-2px);
        }
        .ticker-chart-block.active {
            background-color: #007bff;
            color: white;
            border-color: #0056b3;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .chart-container {
            position: relative; /* íˆ´íŒ ë“± ìœ„ì¹˜ ì¡°ì • */
            width: 100%;
            height: 400px; /* ì°¨íŠ¸ ë†’ì´ ê³ ì • */
            background-color: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            box-sizing: border-box; /* íŒ¨ë”©ì´ ë„ˆë¹„ì— í¬í•¨ë˜ë„ë¡ */
        }
        /* ìƒê´€ê´€ê³„ ë§¤íŠ¸ë¦­ìŠ¤ ìŠ¤íƒ€ì¼ ì œê±°ë¨ */

        /* NEW: Autocomplete styles */
        .autocomplete-results {
            position: absolute; /* ê²€ìƒ‰ì°½ ì•„ë˜ì— ì˜¤ë²„ë ˆì´ë˜ë„ë¡ */
            background-color: #fff;
            border: 1px solid #ddd;
            max-height: 200px; /* ìµœëŒ€ ë†’ì´ ì„¤ì • í›„ ìŠ¤í¬ë¡¤ë°” ìƒì„± */
            overflow-y: auto;
            z-index: 999; /* ë‹¤ë¥¸ ìš”ì†Œ ìœ„ì— ì˜¤ë„ë¡ */
            /* width: calc(100% - 30px); ì´ ë¶€ë¶„ì€ ì•„ë˜ì—ì„œ ì¡°ì • */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-top: 5px; /* ì…ë ¥ í•„ë“œì™€ ê²°ê³¼ ì‚¬ì´ ê°„ê²© */
            /* left: 50%; transform: translateX(-50%); ë¥¼ ë¶€ëª¨ ìš”ì†Œì˜ relative ê¸°ì¤€ìœ¼ë¡œ ì¬ì¡°ì • */
            left: 0; /* stockSearchInputê³¼ ì •ë ¬ */
            right: 0; /* stockSearchInputê³¼ ë„ˆë¹„ ë§ì¶¤ */
            text-align: left; /* í…ìŠ¤íŠ¸ ì •ë ¬ */
            width: 250px; /* stockSearchInputê³¼ ë™ì¼í•œ ë„ˆë¹„ë¡œ ì„¤ì • */
            margin-left: auto; /* ì¤‘ì•™ ì •ë ¬ */
            margin-right: auto; /* ì¤‘ì•™ ì •ë ¬ */
        }

        .autocomplete-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            white-space: nowrap; /* í…ìŠ¤íŠ¸ê°€ ì¤„ë°”ê¿ˆë˜ì§€ ì•Šë„ë¡ */
            overflow: hidden; /* ë„˜ì¹˜ëŠ” í…ìŠ¤íŠ¸ ìˆ¨ê¹€ */
            text-overflow: ellipsis; /* ë„˜ì¹˜ëŠ” í…ìŠ¤íŠ¸ì— ... í‘œì‹œ */
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover {
            background-color: #f0f0f0;
        }

        .autocomplete-item.error {
            color: #cc0000;
            font-style: italic;
        }

        /* Adjust width of the search input for better alignment */
        #stockSearchInput {
            width: 250px; /* ì›í•˜ëŠ” ë„ˆë¹„ë¡œ ì¡°ì • */
            margin-left: 15px; /* ê¸°ì¡´ ë²„íŠ¼ê³¼ì˜ ê°„ê²© */
        }
        /* NEW: ê²€ìƒ‰ í•„ë“œì™€ ë²„íŠ¼ ì‚¬ì´ ê°„ê²© ì¡°ì • */
        #searchAnalysisButton {
            margin-left: 0; /* ê²€ìƒ‰ ë°”ì™€ ì§ì ‘ ë¶™ë„ë¡ */
        }
        .search-area-container {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap; /* ì‘ì€ í™”ë©´ì—ì„œ ìš”ì†Œë“¤ì´ ì¤„ë°”ê¿ˆë˜ë„ë¡ */
            margin-top: 20px;
            position: relative; /* autocomplete-resultsì˜ ê¸°ì¤€ì  */
        }
        .search-area-container label, .search-area-container input, .search-area-container button {
            margin-bottom: 10px; /* ìš”ì†Œë“¤ ê°„ ì„¸ë¡œ ê°„ê²© */
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>ê¸°ì—… íˆ¬ì ë¸Œë¦¬í•‘ ìƒì„±ê¸°</h1>

        <div id="portfolio-overview">
            <p>í¬íŠ¸í´ë¦¬ì˜¤ ì •ë³´ë¥¼ ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>

        <div style="text-align: center; margin-bottom: 25px;">
            <label for="stockSelect">ë‚´ í¬íŠ¸í´ë¦¬ì˜¤ ì£¼ì‹ ë¶„ì„:</label>
            <select id="stockSelect">
                <option value="">-- ì£¼ì‹ì„ ì„ íƒí•˜ì„¸ìš” --</option>
            </select>
            <button onclick="startAnalysis()">ë¶„ì„ ì‹œì‘</button>
            
            <!-- NEW: ê²€ìƒ‰ ì˜ì—­ ì¶”ê°€ -->
            <div class="search-area-container">
                <label for="stockSearchInput">ë‹¤ë¥¸ ì£¼ì‹ ê²€ìƒ‰:</label>
                <input type="text" id="stockSearchInput" placeholder="ê¸°ì—…ëª… ë˜ëŠ” í‹°ì»¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                <button id="searchAnalysisButton" style="display: none;">ê²€ìƒ‰ ë¶„ì„ ì‹œì‘</button>
                <div id="searchResults" class="autocomplete-results"></div> <!-- ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ ì˜ì—­ -->
            </div>
        </div>

        <div id="loading">
            <div class="spinner"></div>
            <div id="loading-message">ë¶„ì„ ì¤€ë¹„ ì¤‘...</div>
            <div id="loading-explanation"></div>
        </div>

        <div id="error-message-container" class="error-message-container">
            <!-- ì˜¤ë¥˜ ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤. -->
        </div>

        <div id="analysis-output-container" style="display:none;">
            <span class="close-analysis-button">Ã—</span>

            <div id="news-summary-section">
                <h2>ê´€ë ¨ ë‰´ìŠ¤ ìš”ì•½</h2>
                <div style="margin-bottom: 15px;">
                    <label for="newsTypeSelect">ë‰´ìŠ¤ ìœ í˜• ì„ íƒ:</label>
                    <select id="newsTypeSelect">
                        <option value="selected_news">í•´ì™¸ ë‰´ìŠ¤</option>
                        <option value="selected_domestic_news">êµ­ë‚´ ë‰´ìŠ¤</option>
                    </select>
                </div>
                <div id="news-list-display">
                    <p>ë‰´ìŠ¤ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>
                </div>
            </div>
            
            <div id="market-data-visualization-section">
                <h2>ì‹œì¥ ë°ì´í„° ì‹œê°í™”</h2>
                <p>ê·¸ë˜í”„ë¥¼ ë³´ê³  ì‹¶ì€ ì¢…ëª©ì´ë‚˜ ì§€í‘œë¥¼ ì„ íƒí•˜ì„¸ìš” (ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥):</p>
                <div id="tickerChartGrid" class="ticker-chart-grid">
                    <!-- í‹°ì»¤ ë¸”ë¡ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
                </div>

                <div class="chart-container">
                    <canvas id="priceChart"></canvas>
                </div>

                <!-- ìƒê´€ê´€ê³„ ë§¤íŠ¸ë¦­ìŠ¤ ì„¹ì…˜ ì‚­ì œë¨ -->
            </div>

            <div id="results"></div>
        </div>
    </div>

    <div id="stockInfoModal" class="stock-info-modal">
        <div class="stock-info-modal-content">
            <span class="close-button close-stock-info-modal-button">Ã—</span>
            <h3>ì£¼ì‹ ì •ë³´</h3>
            <div id="stockInfoContent"></div>
        </div>
    </div>

    <!-- ë‰´ìŠ¤ ìƒì„¸ ëª¨ë‹¬ ì¶”ê°€ -->
    <div id="newsDetailsModal" class="news-details-modal">
        <div class="news-details-modal-content">
            <span class="close-button close-news-details-modal-button">Ã—</span>
            <h3 id="newsDetailsModalTitle"></h3>
            <div id="newsDetailsContent"></div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const socket = io();

            const loadingDiv = document.getElementById('loading');
            const loadingMessage = document.getElementById('loading-message');
            const loadingExplanation = document.getElementById('loading-explanation');
            const errorMessageContainer = document.getElementById('error-message-container');
            const portfolioOverviewDiv = document.getElementById('portfolio-overview');
            
            const analysisOutputContainer = document.getElementById('analysis-output-container');
            const newsSummarySection = document.getElementById('news-summary-section');
            const newsListDisplay = document.getElementById('news-list-display');
            const newsTypeSelect = document.getElementById('newsTypeSelect');
            const resultsDiv = document.getElementById('results');
            const closeAnalysisButton = document.querySelector('.close-analysis-button');

            const marketDataVisualizationSection = document.getElementById('market-data-visualization-section');
            const tickerChartGrid = document.getElementById('tickerChartGrid');
            const priceChartCanvas = document.getElementById('priceChart');
            const priceChartCtx = priceChartCanvas ? priceChartCanvas.getContext('2d') : null;

            let myChart = null;

            const stockInfoModal = document.getElementById('stockInfoModal');
            const stockInfoContent = document.getElementById('stockInfoContent');
            const closeStockInfoModalButton = document.querySelector('.close-stock-info-modal-button'); 

            // ë‰´ìŠ¤ ìƒì„¸ ëª¨ë‹¬ ê´€ë ¨ ìš”ì†Œ
            const newsDetailsModal = document.getElementById('newsDetailsModal');
            const newsDetailsModalTitle = document.getElementById('newsDetailsModalTitle');
            const newsDetailsContent = document.getElementById('newsDetailsContent');
            const closeNewsDetailsModalButton = document.querySelector('.close-news-details-modal-button');

            // NEW: Search elements
            const stockSearchInput = document.getElementById('stockSearchInput');
            const searchResultsDiv = document.getElementById('searchResults');
            const searchAnalysisButton = document.getElementById('searchAnalysisButton');


            const explanations = {
                'ë¶„ì„ ì¤€ë¹„ ì¤‘...': 'ì„œë²„ì— ë¶„ì„ ìš”ì²­ì„ ë³´ë‚´ê³  ìˆìŠµë‹ˆë‹¤.',
                'ë°ì´í„° ì¤€ë¹„ ì¤‘...': 'ê¸°ì—…ì˜ ê¸°ë³¸ ì •ë³´ì™€ ì¬ë¬´ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ë¶„ì„ì˜ ì²«ê±¸ìŒì…ë‹ˆë‹¤.',
                'í•´ì™¸ ë‰´ìŠ¤ ë¶„ì„ ì¤‘...': 'ê¸€ë¡œë²Œ ì‹œì¥ì˜ ìµœì‹  ë‰´ìŠ¤ë¥¼ ë¶„ì„í•˜ì—¬ ê¸°ì—…ì— ë¯¸ì¹  ì ì¬ì  ì˜í–¥ì„ íŒŒì•…í•©ë‹ˆë‹¤.',
                'êµ­ë‚´ ë‰´ìŠ¤ ë¶„ì„ ì¤‘...': 'êµ­ë‚´ ì£¼ìš” ì–¸ë¡  ë° ê¸ˆìœµ ë‰´ìŠ¤ë¥¼ ë¶„ì„í•˜ì—¬ ê¸°ì—…ì˜ í˜„ì¬ ìƒí™©ì„ ì§„ë‹¨í•©ë‹ˆë‹¤.',
                'ì‹œì¥ ë°ì´í„° ë¶„ì„ ì¤‘...': 'ê´€ë ¨ ê¸°ì—… ë° ì‹œì¥ ì§€í‘œì˜ ê³¼ê±° ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ ìƒí˜¸ ì—°ê´€ì„±ê³¼ ì¶”ì„¸ë¥¼ ì˜ˆì¸¡í•©ë‹ˆë‹¤.',
                'ìµœì¢… íˆ¬ì ë¸Œë¦¬í•‘ ìƒì„± ì¤‘...': 'ìˆ˜ì§‘ëœ ëª¨ë“  ì •ë³´ë¥¼ ì¢…í•©í•˜ì—¬ ì¸ê³µì§€ëŠ¥ì´ ìµœì¢… íˆ¬ì ì „ëµê³¼ ë¸Œë¦¬í•‘ì„ ì‘ì„±í•©ë‹ˆë‹¤.'
            };

            let cachedAnalysisData = {
                selectedNews: [],
                selectedDomesticNews: [],
                historicalPrices: {},
                newsEventMarkers: {}, 
                allAnalyzedTickers: [], 
                correlationMatrix: {}, // ìƒê´€ê´€ê³„ ë§¤íŠ¸ë¦­ìŠ¤ëŠ” ì´ì œ ì‚¬ìš©ë˜ì§€ ì•Šì§€ë§Œ, ë°ì´í„° êµ¬ì¡° ì¼ê´€ì„±ì„ ìœ„í•´ ìœ ì§€
                analyzedStockPortfolioSummary: null,
                allKnownTickerNames: {} // í‹°ì»¤ì™€ ì´ë¦„ ë§¤í•‘ì„ ìœ„í•œ ìºì‹œ
            };

            // í™˜ìœ¨ (ì˜ˆì‹œ, ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œëŠ” ë°±ì—”ë“œì—ì„œ ë°›ì•„ì™€ì•¼ í•©ë‹ˆë‹¤)
            const USD_TO_KRW_EXCHANGE_RATE = 1350;


            loadInitialData();

            newsTypeSelect.addEventListener('change', function() {
                displayNewsSummaries(newsTypeSelect.value === 'selected_news' ? cachedAnalysisData.selectedNews : cachedAnalysisData.selectedDomesticNews);
            });

            // ì£¼ì‹ ì •ë³´ ëª¨ë‹¬ ë‹«ê¸°
            closeStockInfoModalButton.addEventListener('click', function() {
                stockInfoModal.style.display = 'none';
            });
            window.addEventListener('click', function(event) {
                if (event.target == stockInfoModal) {
                    stockInfoModal.style.display = 'none';
                }
            });

            // ë‰´ìŠ¤ ìƒì„¸ ëª¨ë‹¬ ë‹«ê¸°
            closeNewsDetailsModalButton.addEventListener('click', function() {
                newsDetailsModal.style.display = 'none';
            });
            window.addEventListener('click', function(event) {
                if (event.target == newsDetailsModal) {
                    newsDetailsModal.style.display = 'none';
                }
            });


            closeAnalysisButton.addEventListener('click', function() {
                analysisOutputContainer.style.display = 'none';
                resultsDiv.innerHTML = '';
                newsListDisplay.innerHTML = '<p>ë‰´ìŠ¤ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>';
                marketDataVisualizationSection.style.display = 'none';
                if (myChart) {
                    myChart.destroy();
                    myChart = null;
                }
                tickerChartGrid.innerHTML = '';
            });

            // NEW: Debounce function for search input
            function debounce(func, delay) {
                let timeout;
                return function(...args) {
                    const context = this;
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(context, args), delay);
                };
            }

            // NEW: Event listener for search input
            stockSearchInput.addEventListener('input', debounce(async (event) => {
                const query = event.target.value.trim();
                searchResultsDiv.innerHTML = ''; // ì´ì „ ê²°ê³¼ ì§€ìš°ê¸°
                searchResultsDiv.style.display = 'none'; // ê²°ê³¼ ìˆ¨ê¸°ê¸°
                searchAnalysisButton.style.display = 'none'; // ë¶„ì„ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
                searchAnalysisButton.dataset.tickerToAnalyze = ''; // ë¶„ì„í•  í‹°ì»¤ ì´ˆê¸°í™”

                if (query.length < 2) { // ìµœì†Œ 2ê¸€ì ì´ìƒ ì…ë ¥ ì‹œ ê²€ìƒ‰
                    return;
                }

                try {
                    const response = await fetch(`/search_stocks?query=${encodeURIComponent(query)}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();

                    if (data.error) {
                        searchResultsDiv.innerHTML = `<div class="autocomplete-item error">ê²€ìƒ‰ ì˜¤ë¥˜: ${data.error}</div>`;
                        searchResultsDiv.style.display = 'block';
                        return;
                    }

                    if (data.length === 0) {
                        searchResultsDiv.innerHTML = `<div class="autocomplete-item">ì¼ì¹˜í•˜ëŠ” ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
                        searchResultsDiv.style.display = 'block';
                        return;
                    }

                    data.forEach(item => {
                        const div = document.createElement('div');
                        div.classList.add('autocomplete-item');
                        div.textContent = `${item.name} (${item.ticker})`;
                        div.dataset.ticker = item.ticker; // í‹°ì»¤ë¥¼ ë°ì´í„° ì†ì„±ì— ì €ì¥
                        div.dataset.name = item.name; // ì´ë¦„ë„ ë°ì´í„° ì†ì„±ì— ì €ì¥
                        div.addEventListener('click', () => {
                            stockSearchInput.value = item.name; // ê²€ìƒ‰ì°½ì— ê¸°ì—…ëª… í‘œì‹œ
                            searchResultsDiv.innerHTML = ''; // ê²°ê³¼ ëª©ë¡ ì§€ìš°ê¸°
                            searchResultsDiv.style.display = 'none'; // ê²°ê³¼ ìˆ¨ê¸°ê¸°
                            
                            // ì„ íƒëœ í‹°ì»¤ë¥¼ ë¶„ì„ ë²„íŠ¼ì— ì €ì¥í•˜ê³  í™œì„±í™”
                            searchAnalysisButton.dataset.tickerToAnalyze = item.ticker;
                            searchAnalysisButton.style.display = 'inline-block'; 
                            
                            // ìºì‹œëœ ì´ë¦„ ì—…ë°ì´íŠ¸
                            cachedAnalysisData.allKnownTickerNames[item.ticker] = item.name;
                        });
                        searchResultsDiv.appendChild(div);
                    });
                    searchResultsDiv.style.display = 'block'; // ê²°ê³¼ í‘œì‹œ
                } catch (error) {
                    console.error('ì£¼ì‹ ê²€ìƒ‰ ì‹¤íŒ¨:', error);
                    searchResultsDiv.innerHTML = `<div class="autocomplete-item error">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}</div>`;
                    searchResultsDiv.style.display = 'block';
                }
            }, 300)); // 300ms ë””ë°”ìš´ìŠ¤ ë”œë ˆì´

            // NEW: ê²€ìƒ‰ ë¶„ì„ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            searchAnalysisButton.addEventListener('click', () => {
                const ticker = searchAnalysisButton.dataset.tickerToAnalyze;
                if (ticker) {
                    startAnalysis(ticker); // startAnalysis í•¨ìˆ˜ì— í‹°ì»¤ ì§ì ‘ ì „ë‹¬
                    // ê²€ìƒ‰ ê´€ë ¨ UI ì´ˆê¸°í™”
                    stockSearchInput.value = '';
                    searchResultsDiv.innerHTML = '';
                    searchResultsDiv.style.display = 'none';
                    searchAnalysisButton.style.display = 'none';
                    searchAnalysisButton.dataset.tickerToAnalyze = '';
                    // í¬íŠ¸í´ë¦¬ì˜¤ ì„ íƒ ë“œë¡­ë‹¤ìš´ì€ ê¸°ë³¸ê°’ìœ¼ë¡œ ë˜ëŒë¦¼ (ì„ íƒ ì‚¬í•­)
                    document.getElementById('stockSelect').value = '';
                } else {
                    showError('ë¶„ì„í•  ì£¼ì‹ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                }
            });

            // NEW: ê²€ìƒ‰ì°½ ì™¸ ë‹¤ë¥¸ ê³³ í´ë¦­ ì‹œ ìë™ ì™„ì„± ê²°ê³¼ ìˆ¨ê¸°ê¸°
            document.addEventListener('click', (event) => {
                if (!stockSearchInput.contains(event.target) && !searchResultsDiv.contains(event.target)) {
                    searchResultsDiv.style.display = 'none';
                }
            });


            async function loadInitialData() {
                const stockSelect = document.getElementById('stockSelect');
                try {
                    const response = await fetch('/portfolio_summary');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();

                    stockSelect.innerHTML = '<option value="">-- ì£¼ì‹ì„ ì„ íƒí•˜ì„¸ìš” --</option>';
                    data.stocks.forEach(stock => {
                        const option = document.createElement('option');
                        option.value = stock.ticker;
                        option.textContent = stock.name;
                        stockSelect.appendChild(option);
                        // ì´ˆê¸° ë¡œë”© ì‹œ í¬íŠ¸í´ë¦¬ì˜¤ ì£¼ì‹ ì´ë¦„ ìºì‹œ
                        cachedAnalysisData.allKnownTickerNames[stock.ticker] = stock.name;
                    });

                    displayPortfolioOverview(data.stocks, data.total_portfolio_summary);

                } catch (error) {
                    console.error('ì´ˆê¸° ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:', error);
                    showError('ì´ˆê¸° í¬íŠ¸í´ë¦¬ì˜¤ ë°ì´í„°ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”: ' + error.message);
                    portfolioOverviewDiv.innerHTML = '<p class="error">í¬íŠ¸í´ë¦¬ì˜¤ ì •ë³´ë¥¼ ë¡œë“œí•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
                }
            }

            // --- í†µí™” ë° ìˆ«ì í¬ë§·íŒ… ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
            function getTickerMarketType(ticker) {
                if (ticker.endsWith('.KS') || ticker.endsWith('.KQ')) {
                    return 'KR';
                }
                // ì ‘ë¯¸ì‚¬ê°€ ì—†ëŠ” ê²½ìš° ë˜ëŠ” ë‹¤ë¥¸ ì ‘ë¯¸ì‚¬ëŠ” ë¯¸êµ­ ì£¼ì‹ìœ¼ë¡œ ê°„ì£¼
                return 'US';
            }

            function formatCurrency(value, marketType, displayCurrency, isPercentage = false) {
                if (value === 'N/A' || typeof value === 'undefined' || value === null) {
                    return 'N/A';
                }

                if (isPercentage) {
                    return `${parseFloat(value).toFixed(2)}%`;
                }

                let numericValue = parseFloat(value);
                let formattedValue;
                let symbol = '';

                if (marketType === 'KR') {
                    symbol = 'â‚©';
                    // ì›í™”ëŠ” ì†Œìˆ˜ì  ì—†ì´ ë°˜ì˜¬ë¦¼
                    formattedValue = Math.round(numericValue).toLocaleString('ko-KR'); 
                } else { // marketType === 'US' (ë‹¬ëŸ¬)
                    if (displayCurrency === 'KRW') {
                        symbol = 'â‚©';
                        // USD -> KRW ë³€í™˜ í›„ ë°˜ì˜¬ë¦¼
                        formattedValue = Math.round(numericValue * USD_TO_KRW_EXCHANGE_RATE).toLocaleString('ko-KR');
                    } else { // displayCurrency === 'USD'
                        symbol = '$';
                        // ë‹¬ëŸ¬ëŠ” ì†Œìˆ˜ì  ë‘ ìë¦¬ ìœ ì§€
                        formattedValue = numericValue.toFixed(2).toLocaleString('en-US'); 
                    }
                }
                return `${symbol} ${formattedValue}`;
            }

            function getProfitLossClass(percentage) {
                if (percentage === 'N/A' || typeof percentage === 'undefined' || percentage === null) return 'neutral';
                if (percentage > 0) return 'profit';
                if (percentage < 0) return 'loss';
                return 'neutral';
            }
            // --- // í†µí™” ë° ìˆ«ì í¬ë§·íŒ… ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---


            function displayPortfolioOverview(stocks, totalSummary) {
                let overviewHtml = `<h2>ë‚´ ì „ì²´ í¬íŠ¸í´ë¦¬ì˜¤ í˜„í™©</h2>`;
                
                // ìƒë‹¨ ìš”ì•½ ì„¹ì…˜
                const totalCurrentValue = totalSummary.total_current_value;
                const totalProfitLoss = totalSummary.total_profit_loss; // ì´ ì†ìµìœ¼ë¡œ í˜„ì¬ ê°€ì¹˜ ìƒ‰ìƒ ê²°ì •
                const totalProfitLossPercentage = totalSummary.total_profit_loss_percentage;

                // ì´ ì†ìµì— ë”°ë¼ í˜„ì¬ ë³´ìœ  ê°€ì¹˜ì˜ ìƒ‰ìƒì„ ê²°ì •
                const totalCurrentValueClass = (totalProfitLoss > 0) ? 'blue' : (totalProfitLoss < 0 ? 'loss' : 'neutral');
                const totalProfitLossPercentageClass = getProfitLossClass(totalProfitLossPercentage);

                overviewHtml += `<div class="top-summary-flex-container">`;
                overviewHtml += `<div class="top-summary-item">`;
                overviewHtml += `<div class="summary-label">í˜„ì¬ ë‚´ ì£¼ì‹ ë³´ìœ  ê°€ì¹˜</div>`;
                // ì´ ë³´ìœ  ê°€ì¹˜ëŠ” í•­ìƒ ì›í™”ë¡œ í‘œì‹œ
                overviewHtml += `<div class="summary-value ${totalCurrentValueClass}">${formatCurrency(totalCurrentValue, 'KR', 'KRW')}</div>`;
                overviewHtml += `</div>`;
                overviewHtml += `<div class="top-summary-item">`;
                overviewHtml += `<div class="summary-label">ì´ ì†ìµë¥ </div>`;
                overviewHtml += `<div class="summary-value ${totalProfitLossPercentageClass}">${formatCurrency(totalProfitLossPercentage, '', '', true)}</div>`;
                overviewHtml += `</div>`;
                overviewHtml += `</div>`;

                // ì£¼ì‹ êµ¬ë¶„
                const koreanStocks = stocks.filter(s => getTickerMarketType(s.ticker) === 'KR');
                const usStocks = stocks.filter(s => getTickerMarketType(s.ticker) === 'US');

                // êµ­ë‚´ ì£¼ì‹ ì„¹ì…˜
                overviewHtml += `<h2 class="market-section-title">êµ­ë‚´ì£¼ì‹</h2>`;
                overviewHtml += buildStockTable(koreanStocks, 'KRW'); // êµ­ë‚´ì£¼ì‹ì€ í•­ìƒ KRW

                // í•´ì™¸ ì£¼ì‹ ì„¹ì…˜
                overviewHtml += `<h2 class="market-section-title">í•´ì™¸ì£¼ì‹</h2>`;
                overviewHtml += `<div class="currency-toggle-buttons">`;
                overviewHtml += `<button class="currency-toggle-btn active" data-currency="USD">USD</button>`;
                overviewHtml += `<button class="currency-toggle-btn" data-currency="KRW">KRW</button>`;
                overviewHtml += `</div>`;
                overviewHtml += buildStockTable(usStocks, 'USD', 'us-stocks-table'); // ê¸°ë³¸ê°’ USD, ID ì¶”ê°€

                portfolioOverviewDiv.innerHTML = overviewHtml;

                // í†µí™” ì „í™˜ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                document.querySelectorAll('.currency-toggle-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const currentDisplayCurrency = this.dataset.currency;
                        document.querySelectorAll('.currency-toggle-btn').forEach(btn => btn.classList.remove('active'));
                        this.classList.add('active');
                        updateForeignStockDisplay(currentDisplayCurrency, usStocks);
                    });
                });
            }

            function buildStockTable(stocksToDisplay, defaultCurrency, tableId = '') {
                if (!stocksToDisplay || stocksToDisplay.length === 0) {
                    return `<p class="no-stock-message">ë³´ìœ í•œ ì£¼ì‹ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
                }
                
                let tableHtml = `<table ${tableId ? `id="${tableId}"` : ''} data-currency-display="${defaultCurrency}">`;
                tableHtml += `<thead><tr><th>ì¢…ëª©ëª…</th><th>í‹°ì»¤</th><th>êµ¬ë§¤ê°€</th><th>ìˆ˜ëŸ‰</th><th>í˜„ì¬ê°€</th><th>ì£¼ë‹¹ ì†ìµ</th><th>ì´ ì†ìµ</th><th>ì†ìµë¥ </th></tr></thead>`;
                tableHtml += `<tbody>`;
                
                stocksToDisplay.forEach(stock => {
                    const profitLossClass = getProfitLossClass(stock.profit_loss_percentage);
                    const marketType = getTickerMarketType(stock.ticker);
                    
                    tableHtml += `<tr>`;
                    tableHtml += `<td>${stock.name}</td>`;
                    tableHtml += `<td>${stock.ticker}</td>`;
                    tableHtml += `<td>${formatCurrency(stock.purchase_price, marketType, defaultCurrency)}</td>`;
                    tableHtml += `<td>${stock.quantity}</td>`;
                    tableHtml += `<td>${formatCurrency(stock.current_price, marketType, defaultCurrency)}</td>`;
                    tableHtml += `<td class="${profitLossClass}">${formatCurrency(stock.profit_loss_per_share, marketType, defaultCurrency)}</td>`;
                    tableHtml += `<td class="${profitLossClass}">${formatCurrency(stock.profit_loss_total, marketType, defaultCurrency)}</td>`;
                    tableHtml += `<td class="${profitLossClass}">${formatCurrency(stock.profit_loss_percentage, '', '', true)}</td>`;
                    tableHtml += `</tr>`;
                });
                tableHtml += `</tbody>`;
                tableHtml += `</table>`;
                return tableHtml;
            }

            function updateForeignStockDisplay(displayCurrency, usStocks) {
                const usStocksTable = document.getElementById('us-stocks-table');
                if (usStocksTable) {
                    usStocksTable.dataset.currencyDisplay = displayCurrency;
                    const tbody = usStocksTable.querySelector('tbody');
                    let newTbodyHtml = '';
                    usStocks.forEach(stock => {
                        const profitLossClass = getProfitLossClass(stock.profit_loss_percentage);
                        const marketType = getTickerMarketType(stock.ticker);
                        newTbodyHtml += `<tr>`;
                        newTbodyHtml += `<td>${stock.name}</td>`;
                        newTbodyHtml += `<td>${stock.ticker}</td>`;
                        newTbodyHtml += `<td>${formatCurrency(stock.purchase_price, marketType, displayCurrency)}</td>`;
                        newTbodyHtml += `<td>${stock.quantity}</td>`;
                        newTbodyHtml += `<td>${formatCurrency(stock.current_price, marketType, displayCurrency)}</td>`;
                        newTbodyHtml += `<td class="${profitLossClass}">${formatCurrency(stock.profit_loss_per_share, marketType, displayCurrency)}</td>`;
                        newTbodyHtml += `<td class="${profitLossClass}">${formatCurrency(stock.profit_loss_total, marketType, displayCurrency)}</td>`;
                        newTbodyHtml += `<td class="${profitLossClass}">${formatCurrency(stock.profit_loss_percentage, '', '', true)}</td>`;
                        newTbodyHtml += `</tr>`;
                    });
                    tbody.innerHTML = newTbodyHtml;
                }
            }


            function showError(message) {
                errorMessageContainer.textContent = message;
                errorMessageContainer.style.display = 'block';
                resultsDiv.innerHTML = '';
                newsListDisplay.innerHTML = '';
                analysisOutputContainer.style.display = 'none';
                marketDataVisualizationSection.style.display = 'none';
            }

            function hideError() {
                errorMessageContainer.textContent = '';
                errorMessageContainer.style.display = 'none';
            }

            // startAnalysis í•¨ìˆ˜ ìˆ˜ì •: ì˜µì…˜ìœ¼ë¡œ í‹°ì»¤ë¥¼ ë°›ì„ ìˆ˜ ìˆê²Œ í•¨
            window.startAnalysis = function(tickerToAnalyze = null) {
                let ticker;
                if (tickerToAnalyze) { // ê²€ìƒ‰ ê¸°ëŠ¥ì„ í†µí•´ í‹°ì»¤ê°€ ì§ì ‘ ì „ë‹¬ëœ ê²½ìš°
                    ticker = tickerToAnalyze;
                } else { // í¬íŠ¸í´ë¦¬ì˜¤ ë“œë¡­ë‹¤ìš´ì„ í†µí•´ ì„ íƒëœ ê²½ìš°
                    const stockSelect = document.getElementById('stockSelect');
                    ticker = stockSelect.value;
                }

                if (!ticker) {
                    showError('ê°œë³„ ì£¼ì‹ ë¶„ì„ì„ ìœ„í•´ ì£¼ì‹ì„ ì„ íƒí•´ ì£¼ì„¸ìš”!');
                    return;
                }

                hideError();
                resultsDiv.innerHTML = '';
                newsListDisplay.innerHTML = '<p>ë‰´ìŠ¤ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>';
                analysisOutputContainer.style.display = 'none';
                marketDataVisualizationSection.style.display = 'none';
                if (myChart) {
                    myChart.destroy();
                    myChart = null;
                }
                tickerChartGrid.innerHTML = '';

                loadingDiv.style.display = 'flex';
                loadingMessage.textContent = 'ë¶„ì„ ì¤€ë¹„ ì¤‘...';
                loadingExplanation.textContent = explanations['ë¶„ì„ ì¤€ë¹„ ì¤‘...'] || '';

                socket.emit('start_analysis_request', { ticker: ticker });
            }

            socket.on('status_update', function(data) {
                loadingMessage.textContent = data.message;
                loadingExplanation.textContent = explanations[data.message] || '';
                
                if (data.progress === -1) {
                    showError(data.message);
                    loadingDiv.style.display = 'none';
                }
            });

            socket.on('analysis_complete', async function(data) {
                console.log("ğŸ”¥ Analysis Complete Data Received:", data);

                loadingDiv.style.display = 'none';
                loadingMessage.textContent = 'ë¶„ì„ ì™„ë£Œ!';
                loadingExplanation.textContent = '';

                cachedAnalysisData.selectedNews = data.selected_news || [];
                cachedAnalysisData.selectedDomesticNews = data.selected_domestic_news || [];
                cachedAnalysisData.historicalPrices = data.historical_prices || {};
                cachedAnalysisData.newsEventMarkers = data.news_event_markers || {};
                cachedAnalysisData.allAnalyzedTickers = data.all_analyzed_tickers || [];
                cachedAnalysisData.correlationMatrix = data.correlation_matrix || {}; 
                cachedAnalysisData.analyzedStockPortfolioSummary = data.portfolio_summary || null; 

                // í˜„ì¬ ë¶„ì„ëœ ì£¼ì‹ì˜ ì´ë¦„ì„ ìºì‹œì— ì¶”ê°€ (ë§Œì•½ í¬íŠ¸í´ë¦¬ì˜¤ì— ì—†ë˜ ì£¼ì‹ì´ë¼ë„)
                if (cachedAnalysisData.analyzedStockPortfolioSummary && cachedAnalysisData.analyzedStockPortfolioSummary.ticker) {
                    cachedAnalysisData.allKnownTickerNames[cachedAnalysisData.analyzedStockPortfolioSummary.ticker] = cachedAnalysisData.analyzedStockPortfolioSummary.name;
                }

                // allAnalyzedTickersì— ìˆëŠ” ëª¨ë“  í‹°ì»¤ì˜ ì´ë¦„ì„ í™•ì¸í•˜ê³ , ì—†ìœ¼ë©´ fetchí•˜ì—¬ ìºì‹œì— ì¶”ê°€
                const nameFetchPromises = [];
                for (const ticker of cachedAnalysisData.allAnalyzedTickers) {
                    if (!cachedAnalysisData.allKnownTickerNames[ticker]) {
                        nameFetchPromises.push(
                            fetch(`/stock_info/${ticker}`)
                                .then(response => response.json())
                                .then(infoData => {
                                    cachedAnalysisData.allKnownTickerNames[ticker] = infoData.name || ticker; 
                                })
                                .catch(error => {
                                    console.warn(`Failed to fetch name for ${ticker}:`, error);
                                    cachedAnalysisData.allKnownTickerNames[ticker] = ticker; 
                                })
                        );
                    }
                }
                await Promise.all(nameFetchPromises); 

                console.log("Cached Historical Prices:", cachedAnalysisData.historicalPrices);
                console.log("Cached News Event Markers:", cachedAnalysisData.newsEventMarkers);
                console.log("Cached All Analyzed Tickes:", cachedAnalysisData.allAnalyzedTickers);
                console.log("Cached Correlation Matrix:", cachedAnalysisData.correlationMatrix);
                console.log("Analyzed Stock Portfolio Summary:", cachedAnalysisData.analyzedStockPortfolioSummary);
                console.log("All known ticker names:", cachedAnalysisData.allKnownTickerNames);


                analysisOutputContainer.style.display = 'block';
                newsTypeSelect.value = 'selected_news';
                displayNewsSummaries(cachedAnalysisData.selectedNews);

                displayResults(data.report, data.portfolio_summary);
                
                marketDataVisualizationSection.style.display = 'block';
                populateTickerChartBlocks(cachedAnalysisData.allAnalyzedTickers); 

                if (cachedAnalysisData.allAnalyzedTickers.length > 0) {
                    setTimeout(() => {
                        const initialTicker = data.portfolio_summary?.ticker || cachedAnalysisData.allAnalyzedTickers[0];
                        const initialBlock = document.querySelector(`.ticker-chart-block[data-tickers*="${initialTicker}"]`); 
                        if (initialBlock) {
                            console.log(`Auto-clicking initial ticker block: ${initialBlock.textContent}`);
                            initialBlock.click();
                        } else {
                            const allOptionBlock = document.querySelector('#tickerChartGrid .ticker-chart-block:first-child');
                            if (allOptionBlock) {
                                console.log("Auto-clicking 'ëª¨ë“  ì¢…ëª©/ì§€í‘œ' block as fallback.");
                                allOptionBlock.click();
                            }
                        }
                    }, 500); 
                }
            });

            function displayNewsSummaries(newsArray) {
                let newsHtml = '';
                if (newsArray && newsArray.length > 0) {
                    newsArray.forEach(news => {
                        newsHtml += `<div class="news-item">`;
                        const newsUrl = news.url || '#';
                        newsHtml += `<h4><a href="${newsUrl}" target="_blank">${news.title}</a></h4>`;
                        newsHtml += `<p>${news.summary}</p>`;
                        const newsDate = news.published_date || news.publish_date;
                        if (newsDate) {
                            newsHtml += `<p style="font-size:0.85em; color:#777;">Published: ${new Date(newsDate).toLocaleDateString()}</p>`;
                        }
                        if (news.related_metrics && news.related_metrics.length > 0) {
                            newsHtml += `<div class="related-tickers"><strong>ì—°ê´€ ê¸°ì—…/ì§€í‘œ:</strong> `;
                            news.related_metrics.forEach(ticker => {
                                // ì—°ê´€ ê¸°ì—…/ì§€í‘œë„ ì´ë¦„ìœ¼ë¡œ í‘œì‹œ
                                const displayName = cachedAnalysisData.allKnownTickerNames[ticker] || ticker;
                                newsHtml += `<span onclick="showStockInfo('${ticker}')">${displayName}</span>`;
                            });
                            newsHtml += `</div>`;
                        }
                        newsHtml += `</div>`;
                    });
                } else {
                    newsHtml += `<p>ì„ íƒëœ ë‰´ìŠ¤ ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
                }
                newsListDisplay.innerHTML = newsHtml;
            }

            window.showStockInfo = async function(ticker) {
                console.log("showStockInfo called for ticker:", ticker);
                stockInfoContent.innerHTML = '<p>ì •ë³´ë¥¼ ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤...</p>';
                stockInfoModal.style.display = 'flex';

                try {
                    const response = await fetch(`/stock_info/${ticker}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();

                    if (data.error) {
                        stockInfoContent.innerHTML = `<p class="error">ì£¼ì‹ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨: ${data.error}</p>`;
                    } else {
                        // ì´ë¦„ ìºì‹œ ì—…ë°ì´íŠ¸
                        cachedAnalysisData.allKnownTickerNames[ticker] = data.name;

                        let infoHtml = `<h3>${data.name} (${data.ticker})</h3>`;
                        const marketType = getTickerMarketType(data.ticker);

                        infoHtml += `<p><strong>í˜„ì¬ ê°€ê²©:</strong> ${formatCurrency(data.current_price, marketType, marketType === 'KR' ? 'KRW' : 'USD')}</p>`;
                        
                        if (data.purchase_price !== null && data.purchase_price !== 'N/A' && data.purchase_price !== undefined) {
                            let profitLossClass = getProfitLossClass(data.profit_loss_percentage);
                            infoHtml += `<p><strong>êµ¬ë§¤ ê°€ê²©:</strong> ${formatCurrency(data.purchase_price, marketType, marketType === 'KR' ? 'KRW' : 'USD')} (ìˆ˜ëŸ‰: ${data.quantity})</p>`;
                            infoHtml += `<p><strong>ì£¼ë‹¹ ì†ìµ:</strong> <span class="${profitLossClass}">${formatCurrency(data.profit_loss_per_share, marketType, marketType === 'KR' ? 'KRW' : 'USD')}</span></p>`;
                            infoHtml += `<p><strong>ì´ ì†ìµ:</strong> <span class="${profitLossClass}">${formatCurrency(data.profit_loss_total, marketType, marketType === 'KR' ? 'KRW' : 'USD')}</span></p>`;
                            infoHtml += `<p><strong>ì†ìµë¥ :</strong> <span class="${profitLossClass}">${formatCurrency(data.profit_loss_percentage, '', '', true)}</span></p>`;
                        } else {
                            infoHtml += `<p><em>ì´ ì£¼ì‹ì€ í¬íŠ¸í´ë¦¬ì˜¤ì— ì—†ê±°ë‚˜ êµ¬ë§¤ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</em></p>`;
                        }
                        stockInfoContent.innerHTML = infoHtml;
                    }
                } catch (error) {
                    console.error('ì£¼ì‹ ì •ë³´ ë¡œë”© ì‹¤íŒ¨:', error);
                    stockInfoContent.innerHTML = `<p class="error">ì£¼ì‹ ì •ë³´ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${error.message}</p>`;
                }
            }


            function displayResults(report, portfolioSummary) {
                let html = '';

                if (portfolioSummary) {
                    const stockName = portfolioSummary.name || portfolioSummary.ticker;
                    const marketType = getTickerMarketType(portfolioSummary.ticker);
                    const defaultDisplayCurrency = marketType === 'KR' ? 'KRW' : 'USD'; 

                    html += `<div class="report-section" style="border-bottom: 2px solid #007bff;">`;
                    html += `<h2>${stockName} (${portfolioSummary.ticker}) ê°œë³„ ë³´ìœ  í˜„í™©</h2>`;
                    if (portfolioSummary.message) {
                        html += `<p class="error">${portfolioSummary.message}</p>`;
                    } else {
                        html += `<p><strong>êµ¬ë§¤ ê°€ê²©:</strong> ${formatCurrency(portfolioSummary.purchase_price, marketType, defaultDisplayCurrency)} (ìˆ˜ëŸ‰: ${portfolioSummary.quantity})</p>`;
                        html += `<p><strong>í˜„ì¬ ê°€ê²©:</strong> ${formatCurrency(portfolioSummary.current_price, marketType, defaultDisplayCurrency)}</p>`;
                        
                        let profitLossClass = getProfitLossClass(portfolioSummary.profit_loss_percentage);

                        html += `<p><strong>ì£¼ë‹¹ ì†ìµ:</strong> <span class="${profitLossClass}">${formatCurrency(portfolioSummary.profit_loss_per_share, marketType, defaultDisplayCurrency)}</span></p>`;
                        html += `<p><strong>ì´ ì†ìµ:</strong> <span class="${profitLossClass}">${formatCurrency(portfolioSummary.profit_loss_total, marketType, defaultDisplayCurrency)}</span></p>`;
                        html += `<p><strong>ì†ìµë¥ :</strong> <span class="${profitLossClass}">${formatCurrency(portfolioSummary.profit_loss_percentage, '', '', true)}</span></p>`;
                    }
                    html += `</div>`;
                }

                if (report.report_title) {
                    html += `<h2>${report.report_title}</h2>`;
                }

                if (report.briefing_summary) {
                    html += `<div class="report-section">`;
                    html += `<h3>ìš”ì•½</h3>`;
                    html += `<p>${report.briefing_summary}</p>`;
                    html += `</div>`;
                }

                if (report.news_analysis && report.news_analysis.entity_analysis) {
                    html += `<div class="report-section">`;
                    html += `<h3>ë‰´ìŠ¤ ë° ì‹œì¥ ë¶„ì„</h3>`;
                    for (const entityKey in report.news_analysis.entity_analysis) {
                        const entity = report.news_analysis.entity_analysis[entityKey];
                        html += `<div class="entity-card">`;
                        html += `<h4>${entityKey}</h4>`;
                        if (entity.ë‚´ìš©) {
                            html += `<p><strong>ë‚´ìš©:</strong> ${entity.ë‚´ìš©}</p>`;
                        }
                        if (entity.ì£¼ê°€_ë°˜ì‘) {
                            html += `<p><strong>ì£¼ê°€ ë°˜ì‘:</strong> ${entity.ì£¼ê°€_ë°˜ì‘}</p>`;
                        }
                        html += `</div>`;
                    }
                    html += `</div>`;
                }

                if (report.strategy_suggestion) {
                    html += `<div class="report-section">`;
                    html += `<h3>íˆ¬ì ì „ëµ ì œì•ˆ</h3>`;
                    html += `<p>${report.strategy_suggestion}</p>`;
                    html += `</div>`;
                }

                resultsDiv.innerHTML = html;
            }


            function populateTickerChartBlocks(allTickers) {
                tickerChartGrid.innerHTML = '';
                if (!allTickers || allTickers.length === 0) {
                    tickerChartGrid.innerHTML = '<p>ì‹œê°í™”í•  ê´€ë ¨ ì¢…ëª©/ì§€í‘œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                // "ëª¨ë“  ì¢…ëª©/ì§€í‘œ" ë¸”ë¡ ìƒì„± (ì—¬ì „íˆ í‹°ì»¤ ëª©ë¡ì„ ë°ì´í„°ì…‹ì— ì €ì¥)
                const allOptionBlock = document.createElement('div');
                allOptionBlock.classList.add('ticker-chart-block');
                allOptionBlock.textContent = 'ëª¨ë“  ì¢…ëª©/ì§€í‘œ';
                allOptionBlock.dataset.tickers = allTickers.join(',');
                allOptionBlock.addEventListener('click', handleTickerChartBlockClick);
                tickerChartGrid.appendChild(allOptionBlock);

                // ê°œë³„ í‹°ì»¤ ë¸”ë¡ ìƒì„± (ê¸°ì—… ì´ë¦„ í‘œì‹œ, ì‹¤ì œ í‹°ì»¤ëŠ” data-tickersì— ì €ì¥)
                allTickers.forEach(ticker => {
                    const block = document.createElement('div');
                    block.classList.add('ticker-chart-block');
                    const displayName = cachedAnalysisData.allKnownTickerNames[ticker] || ticker; 
                    block.textContent = displayName;
                    block.dataset.tickers = ticker; 
                    block.addEventListener('click', handleTickerChartBlockClick);
                    tickerChartGrid.appendChild(block);
                });
                console.log("Ticker chart blocks populated (with company names).");
            }

            async function handleTickerChartBlockClick(event) {
                console.log("Ticker block clicked:", event.target.textContent);
                document.querySelectorAll('.ticker-chart-block').forEach(b => b.classList.remove('active'));
                event.target.classList.add('active');

                // data-tickers ì†ì„±ì—ì„œ ì‹¤ì œ í‹°ì»¤(ë“¤)ì„ ê°€ì ¸ì˜´
                const selectedTickersStr = event.target.dataset.tickers;
                const selectedTickers = selectedTickersStr.split(',');
                console.log("Selected tickers for chart:", selectedTickers);

                const chartDatasets = [];
                const chartAnnotations = [];
                let latestDate = null;

                selectedTickers.forEach(ticker => {
                    const data = cachedAnalysisData.historicalPrices[ticker];
                    if (data && data.length > 0) {
                        // ë‚ ì§œ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬ (í˜¹ì‹œ ëª¨ë¥¼ ê²½ìš°ë¥¼ ëŒ€ë¹„)
                        data.sort((a, b) => new Date(a.date) - new Date(b.date));

                        let basePrice = null;

                        // í˜„ì¬ ë¶„ì„ ì¤‘ì¸ í‹°ì»¤ì´ê³ , êµ¬ë§¤ ê°€ê²©ì´ ìœ íš¨í•œ ê²½ìš° ì‚¬ìš©
                        if (cachedAnalysisData.analyzedStockPortfolioSummary && 
                            cachedAnalysisData.analyzedStockPortfolioSummary.ticker === ticker &&
                            cachedAnalysisData.analyzedStockPortfolioSummary.purchase_price !== null &&
                            cachedAnalysisData.analyzedStockPortfolioSummary.purchase_price !== 'N/A' &&
                            cachedAnalysisData.analyzedStockPortfolioSummary.purchase_price !== 0) {
                            
                            basePrice = parseFloat(cachedAnalysisData.analyzedStockPortfolioSummary.purchase_price);
                            console.log(`Using purchase price as base for ${ticker}: ${basePrice}`);

                        } else if (data[0].close !== null && data[0].close !== 0) { 
                            // ê·¸ë ‡ì§€ ì•Šë‹¤ë©´, ì²« ë²ˆì§¸ ì—­ì‚¬ì  ì¢…ê°€ë¥¼ ê¸°ì¤€ ê°€ê²©ìœ¼ë¡œ ì‚¬ìš©
                            basePrice = parseFloat(data[0].close);
                            console.log(`Using first historical price as base for ${ticker}: ${basePrice}`);
                        } else {
                            console.warn(`Could not determine a valid base price for ${ticker}. Skipping chart data.`);
                            return; 
                        }
                        
                        // ë°±ë¶„ìœ¨ ë³€í™” ê³„ì‚°
                        const datasetData = data.map(item => {
                            let percentageChange = null;
                            if (item.close !== null && basePrice !== null && basePrice !== 0) {
                                percentageChange = ((parseFloat(item.close) - basePrice) / basePrice) * 100;
                            }
                            return { x: item.date, y: percentageChange };
                        }).filter(item => item.y !== null); 

                        if (datasetData.length > 0) {
                             // ì°¨íŠ¸ ë ˆì´ë¸”ë„ ê¸°ì—… ì´ë¦„ìœ¼ë¡œ í‘œì‹œ
                             const displayName = cachedAnalysisData.allKnownTickerNames[ticker] || ticker;
                             chartDatasets.push({
                                label: `${displayName} (% ë³€í™”)`, 
                                data: datasetData,
                                borderColor: getRandomColor(),
                                tension: 0.1,
                                fill: false,
                                pointRadius: 0
                            });
                        }
                    } else {
                        console.warn(`No historical data found for ticker: ${ticker}`);
                    }
                    
                    const newsForTicker = cachedAnalysisData.newsEventMarkers[ticker]; 
                    if (newsForTicker) {
                        // ë‚ ì§œë³„ë¡œ ë‰´ìŠ¤ë“¤ì„ ìˆœíšŒí•˜ë©° Annotation ìƒì„±
                        Object.keys(newsForTicker).sort().forEach(date => {
                            const newsItemsOnDate = newsForTicker[date]; 
                            if (newsItemsOnDate && newsItemsOnDate.length > 0) {
                                chartAnnotations.push({
                                    type: 'line',
                                    mode: 'vertical',
                                    scaleID: 'x',
                                    value: date,
                                    borderColor: 'rgba(255, 99, 132, 0.7)',
                                    borderWidth: 2,
                                    label: {
                                        content: new Date(date).toLocaleDateString(), 
                                        enabled: true,
                                        position: 'top',
                                        font: { size: 8, weight: 'bold' },
                                        color: '#333', 
                                        backgroundColor: 'rgba(255, 255, 255, 0.8)', 
                                        yAdjust: -10,
                                        padding: 3,
                                        borderRadius: 3
                                    },
                                    onClick: (context) => {
                                        console.log(`Annotation clicked for date ${date}, ticker ${ticker}. Showing news details...`);
                                        showNewsDetailsModal(ticker, date, newsItemsOnDate); 
                                    }
                                });
                            }
                        });
                    }
                });
                console.log("Chart Datasets prepared:", chartDatasets);
                console.log("Chart Annotations prepared:", chartAnnotations);
                console.log("Latest Date for chart:", latestDate);

                if (priceChartCtx) {
                    renderPriceChart(chartDatasets, chartAnnotations, latestDate);
                } else {
                    console.error("Canvas context for priceChart is null. Cannot render chart.");
                }
            }

            // ë‰´ìŠ¤ ìƒì„¸ ëª¨ë‹¬ì„ í‘œì‹œí•˜ëŠ” ìƒˆë¡œìš´ í•¨ìˆ˜
            function showNewsDetailsModal(clickedTicker, clickedDate, newsItems) {
                // ëª¨ë‹¬ ì œëª©ì— ê¸°ì—… ì´ë¦„ ì‚¬ìš©
                const displayName = cachedAnalysisData.allKnownTickerNames[clickedTicker] || clickedTicker;
                newsDetailsModalTitle.textContent = `${displayName} - ${new Date(clickedDate).toLocaleDateString()} ë‰´ìŠ¤`;
                let newsHtml = '';
                if (newsItems && newsItems.length > 0) {
                    newsItems.forEach(news => {
                        const newsUrl = news.url || '#';
                        newsHtml += `<div class="news-modal-item">`;
                        newsHtml += `<h4><a href="${newsUrl}" target="_blank">${news.title}</a></h4>`;
                        newsHtml += `<p>${news.summary}</p>`;
                        newsHtml += `</div>`;
                    });
                } else {
                    newsHtml += `<p>ì´ ë‚ ì§œì— ëŒ€í•œ ë‰´ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>`;
                }
                newsDetailsContent.innerHTML = newsHtml;
                newsDetailsModal.style.display = 'flex'; 
            }


            function renderPriceChart(datasets, annotations, latestDate) {
                console.log("Attempting to render chart...");
                if (myChart) {
                    myChart.destroy();
                    myChart = null;
                    console.log("Previous chart destroyed and variable reset.");
                }

                let minDateForView = null;
                if (latestDate) {
                    const latestDateTime = new Date(latestDate);
                    const threeMonthsAgo = new Date(latestDateTime);
                    threeMonthsAgo.setMonth(latestDateTime.getMonth() - 3);
                    minDateForView = threeMonthsAgo.toISOString().split('T')[0];
                    console.log("Chart view range: from", minDateForView, "to", latestDate);
                }

                myChart = new Chart(priceChartCtx, {
                    type: 'line',
                    data: {
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'ì„ íƒëœ ì¢…ëª©/ì§€í‘œ ì£¼ê°€ ì¶”ì´ (ë°±ë¶„ìœ¨ ë³€í™”)' 
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                position: 'nearest',
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += context.parsed.y.toFixed(2) + '%'; 
                                        }
                                        return label;
                                    }
                                }
                            },
                            annotation: {
                                annotations: annotations
                            }
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'month',
                                    tooltipFormat: 'yyyy-MM-dd',
                                    displayFormats: {
                                        day: 'yyyy-MM-dd',
                                        month: 'yyyy-MM'
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'ë‚ ì§œ'
                                },
                                min: minDateForView
                            },
                            y: {
                                beginAtZero: false, 
                                title: {
                                    display: true,
                                    text: 'ê°€ê²© ë³€í™”ìœ¨ (%)' 
                                },
                                ticks: {
                                    callback: function(value, index, values) {
                                        return value + '%'; 
                                    }
                                }
                            }
                        }
                    }
                });
                console.log("Chart rendered successfully. myChart instance:", myChart);
            }

            function getRandomColor() {
                const r = Math.floor(Math.random() * 200);
                const g = Math.floor(Math.random() * 200);
                const b = Math.floor(Math.random() * 200);
                return `rgb(${r},${g},${b})`;
            }
        }); // DOMContentLoaded ë
    </script>
</body>
</html>