<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>미래에셋 투자 브리핑</title>
    <!-- Socket.IO 클라이언트 라이브러리 추가 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Luxon 라이브러리 추가 (Chart.js Date Adapter 필요) -->
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.x/build/global/luxon.min.js"></script>
    <!-- Chart.js Adapter Luxon (시간 데이터 처리용) -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>
    <!-- Chart.js Annotation Plugin for news markers -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script>
    
    <style>
        /* 기본 스타일 - 이 부분을 당신의 원래 프로젝트 CSS로 대체하세요. */
        body { font-family: 'Arial', sans-serif; margin: 20px; background-color: #f4f7f6; color: #333; line-height: 1.6;}
        .container { max-width: 900px; margin: auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        h1 { color: #0056b3; text-align: center; margin-bottom: 30px; }
        h2 { color: #0056b3; border-bottom: 2px solid #007bff; padding-bottom: 5px; margin-top: 40px; }
        h3 { color: #004085; margin-top: 25px; margin-bottom: 10px; font-size: 1.2em; }
        select, button { padding: 12px 20px; margin-right: 15px; border-radius: 5px; border: 1px solid #ddd; font-size: 1em; }
        button { background-color: #007bff; color: white; cursor: pointer; border: none; transition: background-color 0.3s ease; }
        button:hover { background-color: #0056b3; }
        #loading {
            display: none; /* 초기에는 숨김 */
            flex-direction: column; /* 세로 정렬 */
            align-items: center; /* 가운데 정렬 */
            margin-top: 25px;
            padding: 25px;
            background-color: #e6f7ff; /* 연한 파란색 배경 */
            border: 1px solid #91d5ff;
            border-radius: 8px;
            text-align: center;
        }
        .spinner {
            border: 5px solid rgba(0, 0, 0, 0.1);
            border-left: 5px solid #007bff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #loading-message {
            font-size: 1.2em;
            font-weight: bold;
            color: #0056b3;
            margin-bottom: 8px;
        }
        #loading-explanation {
            font-size: 1em;
            color: #666;
            line-height: 1.5;
        }

        #results {
            margin-top: 30px;
            background-color: #f9f9f9;
            padding: 25px;
            border-radius: 8px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        .error-message-container {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background-color: #ffe6e6;
            border: 1px solid #ff9999;
            border-radius: 5px;
            color: #cc0000;
            font-weight: bold;
            text-align: center;
        }
        .report-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px dashed #eee;
        }
        .report-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .entity-card {
            background-color: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .entity-card h4 {
            color: #333;
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.1em;
            border-bottom: 1px dotted #ccc;
            padding-bottom: 5px;
        }
        .entity-card p {
            margin-bottom: 8px;
        }

        /* 손익률 색상 */
        .profit { color: #00a000; font-weight: bold; } /* 녹색 */
        .loss { color: #d00000; font-weight: bold; } /* 빨간색 */
        .neutral { color: #666; } /* 회색 */
        .blue { color: #007bff; font-weight: bold; } /* 파란색 */

        /* 포트폴리오 개요 스타일 */
        #portfolio-overview {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #eaf6ff;
            border: 1px solid #cce7ff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        #portfolio-overview h2 {
            text-align: center;
            color: #0056b3;
            margin-top: 0;
            margin-bottom: 20px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        #portfolio-overview table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        #portfolio-overview th, #portfolio-overview td {
            border: 1px solid #e0e0e0;
            padding: 10px;
            text-align: left;
        }
        #portfolio-overview th {
            background-color: #f0f8ff;
            color: #0056b3;
            font-weight: bold;
        }
        #portfolio-overview .total-summary p {
            margin: 5px 0;
            font-size: 1.1em;
            font-weight: bold;
        }

        /* 뉴스 요약 섹션 스타일 */
        #news-summary-section {
            margin-top: 40px;
            background-color: #f9f9f9;
            padding: 25px;
            border-radius: 8px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        .news-item {
            background-color: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 25px; /* <--- 수정: 뉴스 항목 간의 간격 증가 (15px -> 25px) */
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .news-item h4 {
            margin-top: 0;
            margin-bottom: 10px;
        }
        .news-item h4 a {
            color: #0056b3;
            text-decoration: none;
            font-size: 1.1em;
        }
        .news-item h4 a:hover {
            text-decoration: underline;
        }
        .news-item p {
            font-size: 0.95em;
            color: #555;
        }
        .news-item .related-tickers span {
            display: inline-block;
            background-color: #e0f2f7;
            color: #0056b3;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 0.85em;
            margin-right: 5px;
            margin-bottom: 5px;
            cursor: pointer;
        }
        .news-item .related-tickers span:hover {
            background-color: #cce7ff;
        }
        
        /* 주식 정보 팝업 (모달) 스타일 */
        .stock-info-modal, .news-details-modal { /* 두 모달에 공통 스타일 적용 */
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            display: flex; /* 중앙 정렬을 위해 flex 사용 */
            justify-content: center; /* 수평 중앙 정렬 */
            align-items: center; /* 수직 중앙 정렬 */
        }
        .stock-info-modal-content, .news-details-modal-content { /* 두 모달 콘텐츠에 공통 스타일 적용 */
            background-color: #fefefe;
            padding: 20px;
            border: 1px solid #888;
            border-radius: 8px;
            width: 90%; /* 화면 크기에 따라 조절 */
            max-width: 600px; /* 뉴스 모달은 조금 더 넓게 */
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            position: relative;
        }
        .stock-info-modal-content .close-button, .news-details-modal-content .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .stock-info-modal-content .close-button:hover,
        .stock-info-modal-content .close-button:focus,
        .news-details-modal-content .close-button:hover,
        .news-details-modal-content .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .stock-info-modal-content h3, .news-details-modal-content h3 {
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-top: 0;
        }
        .stock-info-modal-content p, .news-details-modal-content p {
            margin: 8px 0;
        }

        .news-modal-item {
            background-color: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
        }
        .news-modal-item h4 {
            margin-top: 0;
            margin-bottom: 5px;
            font-size: 1em;
        }
        .news-modal-item h4 a {
            color: #0056b3;
            text-decoration: none;
        }
        .news-modal-item p {
            font-size: 0.85em;
            color: #555;
        }


        /* 분석 결과 컨테이너 (새로 추가) */
        #analysis-output-container {
            display: none; /* 초기에는 숨김 */
            position: relative; /* 자식 요소의 absolute 위치 지정을 위함 */
            margin-top: 30px;
            padding-top: 20px; /* 닫기 버튼을 위해 상단 패딩 추가 */
            border-radius: 8px;
            background-color: #fff; /* 컨테이너 배경색 */
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* 컨테이너 그림자 */
        }

        /* 닫기 버튼 스타일 */
        .close-analysis-button {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 2em; /* 크게 만듦 */
            color: #aaa;
            cursor: pointer;
            z-index: 10; /* 다른 요소 위에 오도록 */
            line-height: 0.8; /* 세로 정렬 미세 조정 */
            padding: 5px; /* 클릭 영역 확대 */
        }
        .close-analysis-button:hover {
            color: #333;
        }

        /* 새롭게 추가된 시장 데이터 시각화 섹션 */
        #market-data-visualization-section {
            display: none; /* 분석 완료 시 표시 */
            margin-top: 40px;
            background-color: #f9f9f9;
            padding: 25px;
            border-radius: 8px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        #market-data-visualization-section h2 {
            margin-bottom: 20px;
        }
        .ticker-chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); /* 더 촘촘하게 */
            gap: 10px;
            margin-bottom: 25px;
        }
        .ticker-chart-block {
            background-color: #e8f0fe; /* Light blue */
            border: 1px solid #a8c7fa;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            font-weight: bold;
            font-size: 0.95em;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            white-space: nowrap; /* 티커가 줄바꿈되지 않도록 */
        }
        .ticker-chart-block:hover {
            background-color: #cddcfc;
            transform: translateY(-2px);
        }
        .ticker-chart-block.active {
            background-color: #007bff;
            color: white;
            border-color: #0056b3;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .chart-container {
            position: relative; /* 툴팁 등 위치 조정 */
            width: 100%;
            height: 400px; /* 차트 높이 고정 */
            background-color: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            box-sizing: border-box; /* 패딩이 너비에 포함되도록 */
        }
        /* 상관관계 매트릭스 스타일 제거됨 */

        /* NEW: Autocomplete styles */
        .autocomplete-results {
            position: absolute; /* 검색창 아래에 오버레이되도록 */
            background-color: #fff;
            border: 1px solid #ddd;
            max-height: 200px; /* 최대 높이 설정 후 스크롤바 생성 */
            overflow-y: auto;
            z-index: 999; /* 다른 요소 위에 오도록 */
            /* width: calc(100% - 30px); 이 부분은 아래에서 조정 */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-top: 5px; /* 입력 필드와 결과 사이 간격 */
            /* left: 50%; transform: translateX(-50%); 를 부모 요소의 relative 기준으로 재조정 */
            left: 0; /* stockSearchInput과 정렬 */
            right: 0; /* stockSearchInput과 너비 맞춤 */
            text-align: left; /* 텍스트 정렬 */
            width: 250px; /* stockSearchInput과 동일한 너비로 설정 */
            margin-left: auto; /* 중앙 정렬 */
            margin-right: auto; /* 중앙 정렬 */
        }

        .autocomplete-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            white-space: nowrap; /* 텍스트가 줄바꿈되지 않도록 */
            overflow: hidden; /* 넘치는 텍스트 숨김 */
            text-overflow: ellipsis; /* 넘치는 텍스트에 ... 표시 */
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover {
            background-color: #f0f0f0;
        }

        .autocomplete-item.error {
            color: #cc0000;
            font-style: italic;
        }

        /* Adjust width of the search input for better alignment */
        #stockSearchInput {
            width: 250px; /* 원하는 너비로 조정 */
            margin-left: 15px; /* 기존 버튼과의 간격 */
        }
        /* NEW: 검색 필드와 버튼 사이 간격 조정 */
        #searchAnalysisButton {
            margin-left: 0; /* 검색 바와 직접 붙도록 */
        }
        .search-area-container {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap; /* 작은 화면에서 요소들이 줄바꿈되도록 */
            margin-top: 20px;
            position: relative; /* autocomplete-results의 기준점 */
        }
        .search-area-container label, .search-area-container input, .search-area-container button {
            margin-bottom: 10px; /* 요소들 간 세로 간격 */
        }

        .top-header {
            position: relative; /* 자식 요소의 absolute 위치 기준점 */
            display: flex;
            align-items: center; /* 수직 중앙 정렬 */
            justify-content: flex-start; /* 자식 요소를 왼쪽부터 정렬 */
            padding: 10px 40px;
            background-color: #ffffff;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .top-header h2 {
            position: absolute; /* 헤더 중앙에 절대 위치 */
            left: 50%;
            transform: translateX(-50%);
            margin: 0; /* h2의 기본 마진 제거 */
            font-size: 1.2em; /* 폰트 크기 조정 */
            white-space: nowrap; /* 텍스트가 줄바꿈되지 않도록 */
        }
        .header-logo img {
            height: 80px;
            width: auto;
        }

    </style>
</head>
<body>
    <div class="top-header">
        <a href="https://github.com/Seungwoo-JI64/25-Summer-MIRAEASSET/" target="_blank" class="header-logo">
            <img src="https://velog.velcdn.com/images/persestitan/post/5ef6f63a-c279-465d-b65d-97ff39848f6c/image.jpeg" alt="깃허브 하이퍼링크">
        </a>
        <h2>제9회 2025 미래에셋증권 AI Festival - DATA TADA팀</h2>
    </div>
    <div class="container">
        <h1>기업 투자 브리핑 생성기</h1>

        <div id="portfolio-overview">
            <p>포트폴리오 정보를 로드 중입니다...</p>
        </div>

        <div style="text-align: center; margin-bottom: 25px;">
            <label for="stockSelect">내 포트폴리오 주식 분석:</label>
            <select id="stockSelect">
                <option value="">-- 주식을 선택하세요 --</option>
            </select>
            <label for="otherStockSelect" style="margin-left: 15px;">재무제표 기업 검색:</label>
            <select id="otherStockSelect">
                <option value="">-- 기업을 선택하세요 --</option>
            </select>
            <button onclick="startAnalysis()">분석 시작</button>
            
            <!-- OLD: 검색 영역 (이제 사용되지 않음 - 주석 처리 또는 삭제 가능) -->
            <!-- <div class="search-area-container">
                <label for="stockSearchInput">다른 주식 검색:</label>
                <input type="text" id="stockSearchInput" placeholder="재무제표 기업명 또는 티커">
                <button id="searchAnalysisButton" style="display: none;">검색 분석 시작</button>
                <div id="searchResults" class="autocomplete-results"></div>
            </div> -->
        </div>

        <div id="loading">
            <div class="spinner"></div>
            <div id="loading-message">분석 준비 중...</div>
            <div id="loading-explanation"></div>
        </div>

        <div id="error-message-container" class="error-message-container">
            <!-- 오류 메시지가 여기에 표시됩니다. -->
        </div>

        <div id="analysis-output-container" style="display:none;">
            <span class="close-analysis-button">×</span>

            <div id="news-summary-section">
                <h2>관련 뉴스 요약</h2>
                <div style="margin-bottom: 15px;">
                    <label for="newsTypeSelect">뉴스 유형 선택:</label>
                    <select id="newsTypeSelect">
                        <option value="selected_news">해외 뉴스</option>
                        <option value="selected_domestic_news">국내 뉴스</option>
                    </select>
                </div>
                <div id="news-list-display">
                    <p>뉴스를 분석 중입니다...</p>
                </div>
            </div>
            
            <div id="market-data-visualization-section">
                <h2>시장 데이터 시각화</h2>
                <p>그래프를 보고 싶은 종목이나 지표를 선택하세요. (복수 선택 가능)</p>
                <p>상단은 단기(뉴스 발생 시간 전후), 하단은 장기(2년) 주가 변동을 보여줍니다.</p>

                <div id="tickerChartGrid" class="ticker-chart-grid">
                    <!-- 티커 블록들이 여기에 동적으로 로드됩니다 -->
                </div>

                <div class="chart-container">
                    <canvas id="shortTermPriceChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="longTermPriceChart"></canvas>
                </div>

            </div>

            <div id="results"></div>
        </div>
    </div>

    <div id="stockInfoModal" class="stock-info-modal">
        <div class="stock-info-modal-content">
            <span class="close-button close-stock-info-modal-button">×</span>
            <h3>주식 정보</h3>
            <div id="stockInfoContent"></div>
        </div>
    </div>

    <!-- 뉴스 상세 모달 추가 -->
    <div id="newsDetailsModal" class="news-details-modal">
        <div class="news-details-modal-content">
            <span class="close-button close-news-details-modal-button">×</span>
            <h3 id="newsDetailsModalTitle"></h3>
            <div id="newsDetailsContent"></div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const socket = io();

            const loadingDiv = document.getElementById('loading');
            const loadingMessage = document.getElementById('loading-message');
            const loadingExplanation = document.getElementById('loading-explanation');
            const errorMessageContainer = document.getElementById('error-message-container');
            const portfolioOverviewDiv = document.getElementById('portfolio-overview');
            
            const analysisOutputContainer = document.getElementById('analysis-output-container');
            const newsSummarySection = document.getElementById('news-summary-section');
            const newsListDisplay = document.getElementById('news-list-display');
            const newsTypeSelect = document.getElementById('newsTypeSelect');
            const resultsDiv = document.getElementById('results');
            const closeAnalysisButton = document.querySelector('.close-analysis-button');

            const marketDataVisualizationSection = document.getElementById('market-data-visualization-section');
            const tickerChartGrid = document.getElementById('tickerChartGrid');

            const longTermPriceChartCanvas = document.getElementById('longTermPriceChart');
            const longTermPriceChartCtx = longTermPriceChartCanvas ? longTermPriceChartCanvas.getContext('2d') : null;
            let myLongTermChart = null;
            const shortTermPriceChartCanvas = document.getElementById('shortTermPriceChart');
            const shortTermPriceChartCtx = shortTermPriceChartCanvas ? shortTermPriceChartCanvas.getContext('2d') : null;
            let myShortTermChart = null;

            const stockInfoModal = document.getElementById('stockInfoModal');
            const stockInfoContent = document.getElementById('stockInfoContent');
            const closeStockInfoModalButton = document.querySelector('.close-stock-info-modal-button'); 

            // 뉴스 상세 모달 관련 요소
            const newsDetailsModal = document.getElementById('newsDetailsModal');
            const newsDetailsModalTitle = document.getElementById('newsDetailsModalTitle');
            const newsDetailsContent = document.getElementById('newsDetailsContent');
            const closeNewsDetailsModalButton = document.querySelector('.close-news-details-modal-button');

            // 🚨 OLD: 검색 관련 요소 (이제 사용되지 않으므로 주석 처리 또는 삭제)
            // const stockSearchInput = document.getElementById('stockSearchInput');
            // const searchResultsDiv = document.getElementById('searchResults');
            // const searchAnalysisButton = document.getElementById('searchAnalysisButton');

            // NEW: 다른 주식 선택 드롭다운 요소
            const otherStockSelect = document.getElementById('otherStockSelect');


            const explanations = {
                '분석 준비 중...': '서버에 분석 요청을 보내고 있습니다.',
                '데이터 준비 중...': '기업의 기본 정보와 재무 데이터를 수집하고 있습니다. 이는 분석의 첫걸음입니다.',
                '해외 뉴스 분석 중...': '글로벌 시장의 최신 뉴스를 분석하여 기업에 미칠 잠재적 영향을 파악합니다.',
                '국내 뉴스 분석 중...': '국내 주요 언론 및 금융 뉴스를 분석하여 기업의 현재 상황을 진단합니다.',
                '시장 데이터 분석 중...': '관련 기업 및 시장 지표의 과거 데이터를 분석하여 상호 연관성과 추세를 예측합니다.',
                '최종 투자 브리핑 생성 중...': '수집된 모든 정보를 종합하여 인공지능이 최종 투자 전략과 브리핑을 작성합니다.'
            };

            let cachedAnalysisData = {
                selectedNews: [],
                selectedDomesticNews: [],
                historicalPrices: {},
                short_term_prices: {}, // 단기 데이터 캐시
                newsEventMarkers: {}, 
                allAnalyzedTickers: [], 
                correlationMatrix: {}, // 상관관계 매트릭스는 이제 사용되지 않지만, 데이터 구조 일관성을 위해 유지
                analyzedStockPortfolioSummary: null,
                ko_company_description: "", // 국문 설명을 저장할 필드
                allKnownTickerNames: {} // 티커와 이름 매핑을 위한 캐시
            };

            // 환율 (예시, 실제 서비스에서는 백엔드에서 받아와야 합니다)
            const USD_TO_KRW_EXCHANGE_RATE = 1350;

            // Chart.js를 위한 색상 팔레트 정의 (구분하기 쉬운 색상들)
            const CHART_COLORS = [
                'rgb(75, 192, 192)',   // Teal
                'rgb(255, 99, 132)',    // Red
                'rgb(54, 162, 235)',    // Blue
                'rgb(255, 205, 86)',    // Yellow
                'rgb(153, 102, 255)',   // Purple
                'rgb(255, 159, 64)',    // Orange
                'rgb(0, 128, 0)',       // Dark Green
                'rgb(255, 0, 255)',     // Magenta
                'rgb(0, 206, 209)',     // Dark Turquoise
                'rgb(128, 0, 128)'      // Dark Purple
            ];
            let currentColorIndex = 0; // 팔레트에서 색상을 가져올 인덱스

            function getNextColor() {
                const color = CHART_COLORS[currentColorIndex % CHART_COLORS.length];
                currentColorIndex++; // 다음 호출을 위해 인덱스 증가
                return color;
            }


            loadInitialData();

            newsTypeSelect.addEventListener('change', function() {
                displayNewsSummaries(newsTypeSelect.value === 'selected_news' ? cachedAnalysisData.selectedNews : cachedAnalysisData.selectedDomesticNews);
            });

            // 주식 정보 모달 닫기
            closeStockInfoModalButton.addEventListener('click', function() {
                stockInfoModal.style.display = 'none';
            });
            window.addEventListener('click', function(event) {
                if (event.target == stockInfoModal) {
                    stockInfoModal.style.display = 'none';
                }
            });

            // 뉴스 상세 모달 닫기
            closeNewsDetailsModalButton.addEventListener('click', function() {
                newsDetailsModal.style.display = 'none';
            });
            window.addEventListener('click', function(event) {
                if (event.target == newsDetailsModal) {
                    newsDetailsModal.style.display = 'none';
                }
            });




            // 🚨 OLD: 검색 입력 필드 관련 로직은 모두 제거
            /*
            function debounce(func, delay) {
                let timeout;
                return function(...args) {
                    const context = this;
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(context, args), delay);
                };
            }

            stockSearchInput.addEventListener('input', debounce(async (event) => {
                const query = event.target.value.trim();
                searchResultsDiv.innerHTML = '';
                searchResultsDiv.style.display = 'none';
                searchAnalysisButton.style.display = 'none';
                searchAnalysisButton.dataset.tickerToAnalyze = '';

                if (query.length < 2) {
                    return;
                }

                try {
                    const response = await fetch(`/search_stocks?query=${encodeURIComponent(query)}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();

                    if (data.error) {
                        searchResultsDiv.innerHTML = `<div class="autocomplete-item error">검색 오류: ${data.error}</div>`;
                        searchResultsDiv.style.display = 'block';
                        return;
                    }

                    if (data.length === 0) {
                        searchResultsDiv.innerHTML = `<div class="autocomplete-item">일치하는 재무제표 기업이 없습니다.</div>`;
                        searchResultsDiv.style.display = 'block';
                        return;
                    }

                    data.forEach(item => {
                        const div = document.createElement('div');
                        div.classList.add('autocomplete-item');
                        div.textContent = `${item.name} (${item.ticker})`;
                        div.dataset.ticker = item.ticker;
                        div.dataset.name = item.name;
                        div.addEventListener('click', () => {
                            stockSearchInput.value = item.name;
                            searchResultsDiv.innerHTML = '';
                            searchResultsDiv.style.display = 'none';
                            searchAnalysisButton.dataset.tickerToAnalyze = item.ticker;
                            searchAnalysisButton.style.display = 'inline-block'; 
                            cachedAnalysisData.allKnownTickerNames[item.ticker] = item.name;
                        });
                        searchResultsDiv.appendChild(div);
                    });
                    searchResultsDiv.style.display = 'block';
                } catch (error) {
                    console.error('주식 검색 실패:', error);
                    searchResultsDiv.innerHTML = `<div class="autocomplete-item error">검색 중 오류 발생: ${error.message}</div>`;
                    searchResultsDiv.style.display = 'block';
                }
            }, 300));

            searchAnalysisButton.addEventListener('click', () => {
                const ticker = searchAnalysisButton.dataset.tickerToAnalyze;
                if (ticker) {
                    startAnalysis(ticker);
                    stockSearchInput.value = '';
                    searchResultsDiv.innerHTML = '';
                    searchResultsDiv.style.display = 'none';
                    searchAnalysisButton.style.display = 'none';
                    searchAnalysisButton.dataset.tickerToAnalyze = '';
                    document.getElementById('stockSelect').value = '';
                } else {
                    showError('분석할 주식을 선택해주세요.');
                }
            });

            document.addEventListener('click', (event) => {
                if (stockSearchInput && searchResultsDiv && !stockSearchInput.contains(event.target) && !searchResultsDiv.contains(event.target)) {
                    searchResultsDiv.style.display = 'none';
                }
            });
            */


            async function loadInitialData() {
                const stockSelect = document.getElementById('stockSelect');
                const otherStockSelect = document.getElementById('otherStockSelect');

                try {
                    // 1. 포트폴리오 주식 정보 로드
                    const portfolioResponse = await fetch('/portfolio_summary');
                    if (!portfolioResponse.ok) {
                        throw new Error(`HTTP error! status: ${portfolioResponse.status}`);
                    }
                    const portfolioData = await portfolioResponse.json();

                    stockSelect.innerHTML = '<option value="">-- 주식을 선택하세요 --</option>';
                    portfolioData.stocks.forEach(stock => {
                        // 🚨 NEW: is_analyzable이 true인 포트폴리오 주식만 드롭다운에 추가
                        if (stock.is_analyzable) { 
                            const option = document.createElement('option');
                            option.value = stock.ticker;
                            option.textContent = stock.name;
                            option.dataset.analyzable = stock.is_analyzable; 
                            stockSelect.appendChild(option);
                        }
                        // 초기 로딩 시 모든 포트폴리오 주식 이름 캐시 (분석 가능 여부와 무관하게)
                        cachedAnalysisData.allKnownTickerNames[stock.ticker] = stock.name;
                    });

                    displayPortfolioOverview(portfolioData.stocks, portfolioData.total_portfolio_summary);

                    // 2. 분석 가능한 모든 기업 목록 로드 (새로운 드롭다운용)
                    const analyzableResponse = await fetch('/analyzable_stocks');
                    if (!analyzableResponse.ok) {
                        throw new Error(`HTTP error! status: ${analyzableResponse.status}`);
                    }
                    const analyzableData = await analyzableResponse.json();

                    otherStockSelect.innerHTML = '<option value="">-- 기업을 선택하세요 --</option>';
                    analyzableData.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.ticker;
                        option.textContent = `${item.name} (${item.ticker})`;
                        otherStockSelect.appendChild(option);
                        // 분석 가능한 기업 이름도 캐시
                        cachedAnalysisData.allKnownTickerNames[item.ticker] = item.name;
                    });


                } catch (error) {
                    console.error('초기 데이터 로딩 실패:', error);
                    showError('초기 포트폴리오 및 분석 가능 기업 데이터를 로드할 수 없습니다. 서버가 실행 중인지 확인하세요: ' + error.message);
                    portfolioOverviewDiv.innerHTML = '<p class="error">포트폴리오 정보를 로드하는 데 실패했습니다.</p>';
                }
            }

            // --- 통화 및 숫자 포맷팅 유틸리티 함수 ---
            function getTickerMarketType(ticker) {
                if (ticker.endsWith('.KS') || ticker.endsWith('.KQ')) {
                    return 'KR';
                }
                // 접미사가 없는 경우 또는 다른 접미사는 미국 주식으로 간주
                return 'US';
            }

            function formatCurrency(value, marketType, displayCurrency, isPercentage = false) {
                if (value === 'N/A' || typeof value === 'undefined' || value === null) {
                    return 'N/A';
                }

                if (isPercentage) {
                    return `${parseFloat(value).toFixed(2)}%`;
                }

                let numericValue = parseFloat(value);
                let formattedValue;
                let symbol = '';

                if (marketType === 'KR') {
                    symbol = '₩';
                    // 원화는 소수점 없이 반올림
                    formattedValue = Math.round(numericValue).toLocaleString('ko-KR'); 
                } else { // marketType === 'US' (달러)
                    if (displayCurrency === 'KRW') {
                        symbol = '₩';
                        // USD -> KRW 변환 후 반올림
                        formattedValue = Math.round(numericValue * USD_TO_KRW_EXCHANGE_RATE).toLocaleString('ko-KR');
                    } else { // displayCurrency === 'USD'
                        symbol = '$';
                        // 달러는 소수점 두 자리 유지
                        formattedValue = numericValue.toFixed(2).toLocaleString('en-US'); 
                    }
                }
                return `${symbol} ${formattedValue}`;
            }

            function getProfitLossClass(percentage) {
                if (percentage === 'N/A' || typeof percentage === 'undefined' || percentage === null) return 'neutral';
                if (percentage > 0) return 'profit';
                if (percentage < 0) return 'loss';
                return 'neutral';
            }
            // --- // 통화 및 숫자 포맷팅 유틸리티 함수 ---


            function displayPortfolioOverview(stocks, totalSummary) {
                let overviewHtml = `<h2 class="market-section-title">보유한 포트폴리오</h2>`;
                
                // // 상단 요약 섹션
                // const totalCurrentValue = totalSummary.total_current_value;
                // const totalProfitLoss = totalSummary.total_profit_loss; // 총 손익으로 현재 가치 색상 결정
                // const totalProfitLossPercentage = totalSummary.total_profit_loss_percentage;

                // // 총 손익에 따라 현재 보유 가치의 색상을 결정
                // const totalCurrentValueClass = (totalProfitLoss > 0) ? 'blue' : (totalProfitLoss < 0 ? 'loss' : 'neutral');
                // const totalProfitLossPercentageClass = getProfitLossClass(totalProfitLossPercentage);

                // overviewHtml += `<div class="top-summary-flex-container">`;
                // overviewHtml += `<div class="top-summary-item">`;
                // overviewHtml += `<div class="summary-label">현재 내 주식 보유 가치</div>`;
                // // 총 보유 가치는 항상 원화로 표시
                // overviewHtml += `<div class="summary-value ${totalCurrentValueClass}">${formatCurrency(totalCurrentValue, 'KR', 'KRW')}</div>`;
                // overviewHtml += `</div>`;
                // overviewHtml += `<div class="top-summary-item">`;
                // overviewHtml += `<div class="summary-label">총 손익률</div>`;
                // overviewHtml += `<div class="summary-value ${totalProfitLossPercentageClass}">${formatCurrency(totalProfitLossPercentage, '', '', true)}</div>`;
                // overviewHtml += `</div>`;
                // overviewHtml += `</div>`;

                // 주식 구분
                const koreanStocks = stocks.filter(s => getTickerMarketType(s.ticker) === 'KR');
                const usStocks = stocks.filter(s => getTickerMarketType(s.ticker) === 'US');

                // 국내 주식 섹션
                // overviewHtml += `<h2 class="market-section-title">보유한 포트폴리오</h2>`;
                overviewHtml += buildStockTable(koreanStocks, 'KRW'); // 국내주식은 항상 KRW

                // 해외 주식 섹션
                // overviewHtml += `<h2 class="market-section-title">해외주식</h2>`;
                // overviewHtml += `<div class="currency-toggle-buttons">`;
                // overviewHtml += `<button class="currency-toggle-btn active" data-currency="USD">USD</button>`;
                // overviewHtml += `<button class="currency-toggle-btn" data-currency="KRW">KRW</button>`;
                // overviewHtml += `</div>`;
                // overviewHtml += buildStockTable(usStocks, 'USD', 'us-stocks-table'); // 기본값 USD, ID 추가

                portfolioOverviewDiv.innerHTML = overviewHtml;

                // 통화 전환 버튼 이벤트 리스너 추가
                document.querySelectorAll('.currency-toggle-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const currentDisplayCurrency = this.dataset.currency;
                        document.querySelectorAll('.currency-toggle-btn').forEach(btn => btn.classList.remove('active'));
                        this.classList.add('active');
                        updateForeignStockDisplay(currentDisplayCurrency, usStocks);
                    });
                });
            }

            function buildStockTable(stocksToDisplay, defaultCurrency, tableId = '') {
                if (!stocksToDisplay || stocksToDisplay.length === 0) {
                    return `<p class="no-stock-message">보유한 주식이 없습니다.</p>`;
                }
                
                let tableHtml = `<table ${tableId ? `id="${tableId}"` : ''} data-currency-display="${defaultCurrency}">`;
                tableHtml += `<thead><tr><th>종목명</th><th>티커</th><th>구매가</th><th>수량</th><th>현재가</th><th>주당 손익</th><th>총 손익</th><th>손익률</th></tr></thead>`;
                tableHtml += `<tbody>`;
                
                stocksToDisplay.forEach(stock => {
                    const profitLossClass = getProfitLossClass(stock.profit_loss_percentage);
                    const marketType = getTickerMarketType(stock.ticker);
                    
                    tableHtml += `<tr>`;
                    tableHtml += `<td>${stock.name}</td>`;
                    tableHtml += `<td>${stock.ticker}</td>`;
                    tableHtml += `<td>${formatCurrency(stock.purchase_price, marketType, defaultCurrency)}</td>`;
                    tableHtml += `<td>${stock.quantity}</td>`;
                    tableHtml += `<td>${formatCurrency(stock.current_price, marketType, defaultCurrency)}</td>`;
                    tableHtml += `<td class="${profitLossClass}">${formatCurrency(stock.profit_loss_per_share, marketType, defaultCurrency)}</td>`;
                    tableHtml += `<td class="${profitLossClass}">${formatCurrency(stock.profit_loss_total, marketType, defaultCurrency)}</td>`;
                    tableHtml += `<td class="${profitLossClass}">${formatCurrency(stock.profit_loss_percentage, '', '', true)}</td>`;
                    tableHtml += `</tr>`;
                });
                tableHtml += `</tbody>`;
                tableHtml += `</table>`;
                return tableHtml;
            }

            function updateForeignStockDisplay(displayCurrency, usStocks) {
                const usStocksTable = document.getElementById('us-stocks-table');
                if (usStocksTable) {
                    usStocksTable.dataset.currencyDisplay = displayCurrency;
                    const tbody = usStocksTable.querySelector('tbody');
                    let newTbodyHtml = '';
                    usStocks.forEach(stock => {
                        const profitLossClass = getProfitLossClass(stock.profit_loss_percentage);
                        const marketType = getTickerMarketType(stock.ticker);
                        newTbodyHtml += `<tr>`;
                        newTbodyHtml += `<td>${stock.name}</td>`;
                        newTbodyHtml += `<td>${stock.ticker}</td>`;
                        newTbodyHtml += `<td>${formatCurrency(stock.purchase_price, marketType, displayCurrency)}</td>`;
                        newTbodyHtml += `<td>${stock.quantity}</td>`;
                        newTbodyHtml += `<td>${formatCurrency(stock.current_price, marketType, displayCurrency)}</td>`;
                        newTbodyHtml += `<td class="${profitLossClass}">${formatCurrency(stock.profit_loss_per_share, marketType, displayCurrency)}</td>`;
                        newTbodyHtml += `<td class="${profitLossClass}">${formatCurrency(stock.profit_loss_total, marketType, displayCurrency)}</td>`;
                        newTbodyHtml += `<td class="${profitLossClass}">${formatCurrency(stock.profit_loss_percentage, '', '', true)}</td>`;
                        newTbodyHtml += `</tr>`;
                    });
                    tbody.innerHTML = newTbodyHtml;
                }
            }


            function showError(message) {
                errorMessageContainer.textContent = message;
                errorMessageContainer.style.display = 'block';
                resultsDiv.innerHTML = '';
                newsListDisplay.innerHTML = '';
                analysisOutputContainer.style.display = 'none';
                marketDataVisualizationSection.style.display = 'none';
            }

            function hideError() {
                errorMessageContainer.textContent = '';
                errorMessageContainer.style.display = 'none';
            }

            
            socket.on('status_update', function(data) {
                loadingMessage.textContent = data.message;
                loadingExplanation.textContent = explanations[data.message] || '';
                
                if (data.progress === -1) {
                    showError(data.message);
                    loadingDiv.style.display = 'none';
                }
            });

            socket.on('analysis_complete', async function(data) {
                console.log("🔥 Analysis Complete Data Received:", data);
                
                loadingDiv.style.display = 'none';
                loadingMessage.textContent = '분석 완료!';
                loadingExplanation.textContent = '';
                
                cachedAnalysisData.selectedNews = data.selected_news || [];
                cachedAnalysisData.selectedDomesticNews = data.selected_domestic_news || [];
                cachedAnalysisData.historicalPrices = data.historical_prices || {};
                cachedAnalysisData.short_term_prices = data.short_term_prices || {}; // 단기 데이터 캐시
                cachedAnalysisData.newsEventMarkers = data.news_event_markers || {};
                cachedAnalysisData.allAnalyzedTickers = data.all_analyzed_tickers || [];
                cachedAnalysisData.correlationMatrix = data.correlation_matrix || {}; 
                cachedAnalysisData.analyzedStockPortfolioSummary = data.portfolio_summary || null; 
                cachedAnalysisData.ko_company_description = data.ko_company_description || "기업 설명이 없습니다.";
                
                // 현재 분석된 주식의 이름을 캐시에 추가 (만약 포트폴리오에 없던 주식이라도)
                if (cachedAnalysisData.analyzedStockPortfolioSummary && cachedAnalysisData.analyzedStockPortfolioSummary.ticker) {
                    cachedAnalysisData.allKnownTickerNames[cachedAnalysisData.analyzedStockPortfolioSummary.ticker] = cachedAnalysisData.analyzedStockPortfolioSummary.name;
                }
                
                // allAnalyzedTickers에 있는 모든 티커의 이름을 확인하고, 없으면 fetch하여 캐시에 추가
                const nameFetchPromises = [];
                for (const ticker of cachedAnalysisData.allAnalyzedTickers) {
                    if (!cachedAnalysisData.allKnownTickerNames[ticker]) {
                        nameFetchPromises.push(
                            fetch(`/stock_info/${ticker}`)
                            .then(response => response.json())
                            .then(infoData => {
                                    cachedAnalysisData.allKnownTickerNames[ticker] = infoData.name || ticker; 
                                })
                                .catch(error => {
                                    console.warn(`Failed to fetch name for ${ticker}:`, error);
                                    cachedAnalysisData.allKnownTickerNames[ticker] = ticker; 
                                })
                        );
                    }
                }
                await Promise.all(nameFetchPromises); 
                
                console.log("Cached Historical Prices:", cachedAnalysisData.historicalPrices);
                console.log("Cached News Event Markers:", cachedAnalysisData.newsEventMarkers);
                console.log("Cached All Analyzed Tickes:", cachedAnalysisData.allAnalyzedTickers);
                console.log("Cached Correlation Matrix:", cachedAnalysisData.correlationMatrix);
                console.log("Analyzed Stock Portfolio Summary:", cachedAnalysisData.analyzedStockPortfolioSummary);
                console.log("All known ticker names:", cachedAnalysisData.allKnownTickerNames);
                
                
                analysisOutputContainer.style.display = 'block';
                newsTypeSelect.value = 'selected_news';
                displayNewsSummaries(cachedAnalysisData.selectedNews);
                
                displayResults(data.report, data.portfolio_summary,  cachedAnalysisData.ko_company_description);
                
                marketDataVisualizationSection.style.display = 'block';
                populateTickerChartBlocks(cachedAnalysisData.allAnalyzedTickers); 
                
                if (cachedAnalysisData.allAnalyzedTickers.length > 0) {
                    setTimeout(() => {
                        const initialTicker = data.portfolio_summary?.ticker || cachedAnalysisData.allAnalyzedTickers[0];
                        const initialBlock = document.querySelector(`.ticker-chart-block[data-tickers*="${initialTicker}"]`); 
                        if (initialBlock) {
                            console.log(`Auto-clicking initial ticker block: ${initialBlock.textContent}`);
                            initialBlock.click();
                        } else {
                            const allOptionBlock = document.querySelector('#tickerChartGrid .ticker-chart-block:first-child');
                            if (allOptionBlock) {
                                console.log("Auto-clicking '모든 종목/지표' block as fallback.");
                                allOptionBlock.click();
                            }
                        }
                    }, 500); 
                }
            });
            
            function displayNewsSummaries(newsArray) {
                let newsHtml = '';
                if (newsArray && newsArray.length > 0) {
                    newsArray.forEach(news => {
                        newsHtml += `<div class="news-item">`;
                            const newsUrl = news.url || '#';
                        newsHtml += `<h4><a href="${newsUrl}" target="_blank">${news.title}</a></h4>`;
                        newsHtml += `<p>${news.summary}</p>`;
                        const newsDate = news.published_date || news.publish_date;
                        if (newsDate) {
                            newsHtml += `<p style="font-size:0.85em; color:#777;">Published: ${new Date(newsDate).toLocaleDateString()}</p>`;
                        }
                        if (news.related_metrics && news.related_metrics.length > 0) {
                            newsHtml += `<div class="related-tickers"><strong>연관 기업/지표:</strong> `;
                                news.related_metrics.forEach(ticker => {
                                    // 연관 기업/지표도 이름으로 표시
                                const displayName = cachedAnalysisData.allKnownTickerNames[ticker] || ticker;
                                newsHtml += `<span onclick="showStockInfo('${ticker}')">${displayName}</span>`;
                            });
                            newsHtml += `</div>`;
                        }
                        newsHtml += `</div>`;
                    });
                } else {
                    newsHtml += `<p>선택된 뉴스 분석 결과가 없습니다.</p>`;
                }
                newsListDisplay.innerHTML = newsHtml;
            }
            
            window.showStockInfo = async function(ticker) {
                console.log("showStockInfo called for ticker:", ticker);
                stockInfoContent.innerHTML = '<p>정보를 로드 중입니다...</p>';
                stockInfoModal.style.display = 'flex';
                try {
                    const response = await fetch(`/stock_info/${ticker}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    
                    if (data.error) {
                        stockInfoContent.innerHTML = `<p class="error">정보 로드 실패: ${data.error}</p>`;
                    } else {
                        // API로부터 받은 이름과 국문 설명으로 팝업 내용을 구성합니다.
                        let infoHtml = `<h3>${data.name} (${ticker})</h3>`;
                        // DB의 줄바꿈 문자를 HTML의 <br> 태그로 변환하여 가독성을 높입니다.
                        infoHtml += `<p>${data.ko_summary.replace(/\n/g, '<br>')}</p>`;
                        stockInfoContent.innerHTML = infoHtml;
                    }
                } catch (error) {
                    console.error('주식 정보 로딩 실패:', error);
                    stockInfoContent.innerHTML = `<p class="error">정보를 로드할 수 없습니다: ${error.message}</p>`;
                }
            
                
                /*    try {
                    const response = await fetch(`/stock_info/${ticker}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const data = await response.json();
                        
                        if (data.error) {
                            stockInfoContent.innerHTML = `<p class="error">주식 정보 로드 실패: ${data.error}</p>`;
                            } else {
                                // 이름 캐시 업데이트
                            cachedAnalysisData.allKnownTickerNames[ticker] = data.name;
                            
                            let infoHtml = `<h3>${data.name} (${data.ticker})</h3>`;
                            const marketType = getTickerMarketType(data.ticker);
                            
                            infoHtml += `<p><strong>현재 가격:</strong> ${formatCurrency(data.current_price, marketType, marketType === 'KR' ? 'KRW' : 'USD')}</p>`;
                            
                            if (data.purchase_price !== null && data.purchase_price !== 'N/A' && data.purchase_price !== undefined) {
                            let profitLossClass = getProfitLossClass(data.profit_loss_percentage);
                            infoHtml += `<p><strong>구매 가격:</strong> ${formatCurrency(data.purchase_price, marketType, marketType === 'KR' ? 'KRW' : 'USD')} (수량: ${data.quantity})</p>`;
                            infoHtml += `<p><strong>주당 손익:</strong> <span class="${profitLossClass}">${formatCurrency(data.profit_loss_per_share, marketType, marketType === 'KR' ? 'KRW' : 'USD')}</span></p>`;
                            infoHtml += `<p><strong>총 손익:</strong> <span class="${profitLossClass}">${formatCurrency(data.profit_loss_total, marketType, marketType === 'KR' ? 'KRW' : 'USD')}</span></p>`;
                            infoHtml += `<p><strong>손익률:</strong> <span class="${profitLossClass}">${formatCurrency(data.profit_loss_percentage, '', '', true)}</span></p>`;
                            } else {
                            infoHtml += `<p><em>이 주식은 포트폴리오에 없거나 구매 정보가 없습니다.</em></p>`;
                    }
                        stockInfoContent.innerHTML = infoHtml;
                        }
                        } catch (error) {
                            console.error('주식 정보 로딩 실패:', error);
                            stockInfoContent.innerHTML = `<p class="error">주식 정보를 로드할 수 없습니다: ${error.message}</p>`;
                            }
                            */
                        }
                        

                        
                        function displayResults(report, portfolioSummary, ko_company_description) {
                            let html = '';
                            const stockName = portfolioSummary.name || portfolioSummary.ticker;
                            html += `<div class="report-section" style="border-bottom: 2px solid #007bff;">`;
                html += `<h2>${stockName} (${portfolioSummary.ticker}) 기업 개요</h2>`;
                html += `<p>${ko_company_description}</p>`; // 받아온 국문 설명을 여기에 표시
                html += `</div>`;
                
                // 🚨 NEW: is_portfolio_holding 플래그를 확인하여 개별 보유 현황 섹션 표시 여부 결정
                /*if (portfolioSummary && portfolioSummary.is_portfolio_holding) {
                    const stockName = portfolioSummary.name || portfolioSummary.ticker;
                    const marketType = getTickerMarketType(portfolioSummary.ticker);
                    const defaultDisplayCurrency = marketType === 'KR' ? 'KRW' : 'USD'; 
                    
                    html += `<div class="report-section" style="border-bottom: 2px solid #007bff;">`;
                        html += `<h2>${stockName} (${portfolioSummary.ticker}) 개별 보유 현황</h2>`;
                        // portfolioSummary.message는 is_portfolio_holding이 false일 때만 설정되므로, 여기서는 불필요
                        html += `<p><strong>구매 가격:</strong> ${formatCurrency(portfolioSummary.purchase_price, marketType, defaultDisplayCurrency)} (수량: ${portfolioSummary.quantity})</p>`;
                        html += `<p><strong>현재 가격:</strong> ${formatCurrency(portfolioSummary.current_price, marketType, defaultDisplayCurrency)}</p>`;
                        
                        
                        
                        let profitLossClass = getProfitLossClass(portfolioSummary.profit_loss_percentage);
                        
                        html += `<p><strong>주당 손익:</strong> <span class="${profitLossClass}">${formatCurrency(portfolioSummary.profit_loss_per_share, marketType, defaultDisplayCurrency)}</span></p>`;
                        html += `<p><strong>총 손익:</strong> <span class="${profitLossClass}">${formatCurrency(portfolioSummary.profit_loss_total, marketType, defaultDisplayCurrency)}</span></p>`;
                        html += `<p><strong>손익률:</strong> <span class="${profitLossClass}">${formatCurrency(portfolioSummary.profit_loss_percentage, '', '', true)}</span></p>`;
                        html += `</div>`;
                        } else if (portfolioSummary && portfolioSummary.name && portfolioSummary.ticker) {
                            const stockName = portfolioSummary.name || portfolioSummary.ticker;
                            const marketType = getTickerMarketType(portfolioSummary.ticker);
                            html += `<div class="report-section" style="border-bottom: 1px dashed #eee;">`;
                                // 보유하지 않은 주식이라도 현재 가격은 보여줄 수 있도록 (간략 정보)
                                html += `<h2>${stockName} (${portfolioSummary.ticker}) 현재 가격 정보</h2>`;
                                html += `<p><strong>현재 가격:</strong> ${formatCurrency(portfolioSummary.current_price, marketType, marketType === 'KR' ? 'KRW' : 'USD')}</p>`;
                                html += `<p><em>이 주식은 포트폴리오에 보유하고 있지 않습니다.</em></p>`;
                                html += `</div>`;
                                
                                }*/
                               

                               if (report.report_title) {
                    html += `<h2>${report.report_title}</h2>`;
                }
                
                if (report.briefing_summary) {
                    html += `<div class="report-section">`;
                        html += `<h3>요약</h3>`;
                        html += `<p>${report.briefing_summary}</p>`;
                        html += `</div>`;
                    }
                    
                    if (report.news_analysis && report.news_analysis.entity_analysis) {
                        html += `<div class="report-section">`;
                            html += `<h3>뉴스 및 시장 분석</h3>`;
                            for (const entityKey in report.news_analysis.entity_analysis) {
                                const entity = report.news_analysis.entity_analysis[entityKey];
                        html += `<div class="entity-card">`;
                            html += `<h4>${entityKey}</h4>`;
                        if (entity.내용) {
                            html += `<p><strong>내용:</strong> ${entity.내용}</p>`;
                        }
                        if (entity.주가_반응) {
                            html += `<p><strong>주가 반응:</strong> ${entity.주가_반응}</p>`;
                        }
                        html += `</div>`;
                    }
                    html += `</div>`;
                }
                
                if (report.strategy_suggestion) {
                    html += `<div class="report-section">`;
                    html += `<h3>투자 전략 제안</h3>`;
                    html += `<p>${report.strategy_suggestion}</p>`;
                    html += `</div>`;
                }
                
                resultsDiv.innerHTML = html;
            }
            
            
            function populateTickerChartBlocks(allTickers) {
                tickerChartGrid.innerHTML = '';
                if (!allTickers || allTickers.length === 0) {
                    tickerChartGrid.innerHTML = '<p>시각화할 관련 종목/지표가 없습니다.</p>';
                    return;
                }
                
                // "모든 종목/지표" 블록 생성 (여전히 티커 목록을 데이터셋에 저장)
                const allOptionBlock = document.createElement('div');
                allOptionBlock.classList.add('ticker-chart-block');
                allOptionBlock.textContent = '모든 종목/지표';
                allOptionBlock.dataset.tickers = allTickers.join(',');
                allOptionBlock.addEventListener('click', handleTickerChartBlockClick);
                tickerChartGrid.appendChild(allOptionBlock);
                
                // 개별 티커 블록 생성 (기업 이름 표시, 실제 티커는 data-tickers에 저장)
                allTickers.forEach(ticker => {
                    const block = document.createElement('div');
                    block.classList.add('ticker-chart-block');
                    const displayName = cachedAnalysisData.allKnownTickerNames[ticker] || ticker; 
                    block.textContent = displayName;
                    block.dataset.tickers = ticker; 
                    block.addEventListener('click', handleTickerChartBlockClick);
                    tickerChartGrid.appendChild(block);
                });
                console.log("Ticker chart blocks populated (with company names).");
            }

            function handleTickerChartBlockClick(event) {
                console.log("Ticker block clicked:", event.target.textContent);
                document.querySelectorAll('.ticker-chart-block').forEach(b => b.classList.remove('active'));
                event.target.classList.add('active');
                
                const selectedTickers = event.target.dataset.tickers.split(',');
                console.log("Selected tickers for chart:", selectedTickers);

                // 수정된 부분: 이 두 함수를 호출하는 것 외에 다른 모든 코드를 제거합니다.
                updateLongTermChart(selectedTickers);
                updateShortTermChart(selectedTickers);
            }
            
            
            // 장기 차트 업데이트 함수 
            function updateLongTermChart(tickers) {
                const datasets = [];
                const annotations = [];
                currentColorIndex = 0;
                
                tickers.forEach(ticker => {
                    const data = cachedAnalysisData.historicalPrices[ticker];
                    if (data && data.length > 0) {
                        data.sort((a, b) => new Date(a.date) - new Date(b.date));
                        let basePrice = (data[0].close !== null && data[0].close !== 0) ? parseFloat(data[0].close) : null;
                        if (cachedAnalysisData.analyzedStockPortfolioSummary?.ticker === ticker && cachedAnalysisData.analyzedStockPortfolioSummary?.purchase_price > 0 && cachedAnalysisData.analyzedStockPortfolioSummary?.is_portfolio_holding) {
                            basePrice = parseFloat(cachedAnalysisData.analyzedStockPortfolioSummary.purchase_price);
                        }
                        if (basePrice === null) return;
                        const datasetData = data.map(item => ({ x: item.date, y: ((parseFloat(item.close) - basePrice) / basePrice) * 100 })).filter(item => !isNaN(item.y));
                        if (datasetData.length > 0) {
                            const displayName = cachedAnalysisData.allKnownTickerNames[ticker] || ticker;
                            datasets.push({ label: `${displayName} (% 변화)`, data: datasetData, borderColor: getNextColor(), tension: 0.1, fill: false, pointRadius: 0 });
                        }
                    }
                    // ... (기존의 뉴스 마커(annotation) 생성 로직과 동일) ...
                    const newsForTicker = cachedAnalysisData.newsEventMarkers[ticker];
                    if (newsForTicker) {
                        Object.keys(newsForTicker).sort().forEach(date => {
                            const newsItemsOnDate = newsForTicker[date];
                            if (newsItemsOnDate && newsItemsOnDate.length > 0) {
                                annotations.push({
                                    type: 'line', mode: 'vertical', scaleID: 'x', value: date, borderColor: 'rgba(255, 99, 132, 0.7)', borderWidth: 2,
                                    label: { content: new Date(date).toLocaleDateString(), enabled: true, position: 'top', font: { size: 8 }, yAdjust: -10 },
                                    onClick: () => showNewsDetailsModal(ticker, date, newsItemsOnDate)
                                });
                            }
                        });
                    }
                });

                annotations.push({ type: 'line', mode: 'horizontal', scaleID: 'y', value: 0, borderColor: 'black', borderWidth: 2});
                renderPriceChart(myLongTermChart, longTermPriceChartCtx, datasets, annotations, '장기 주가 추이 (기준가 대비 %)');
            }
            
            // 단기 차트 업데이트 함수
            function updateShortTermChart(tickers) {
                const datasets = [];
                currentColorIndex = 0; // 색상 팔레트 초기화
                
                tickers.forEach(ticker => {
                    const data = cachedAnalysisData.short_term_prices[ticker];
                    if (data && data.length > 0) {
                        // 단기 데이터는 첫 번째 값을 기준으로 변동률 계산
                        const basePrice = parseFloat(data[0].close);
                        if (basePrice > 0) {
                            const datasetData = data.map(item => ({ x: item.date, y: ((parseFloat(item.close) - basePrice) / basePrice) * 100 }));
                            const displayName = cachedAnalysisData.allKnownTickerNames[ticker] || ticker;
                            datasets.push({ label: `${displayName} (% 변화)`, data: datasetData, borderColor: getNextColor(), tension: 0.1, fill: false, pointRadius: 1 });
                        }
                    }
                });
                
                const annotations = [{ type: 'line', mode: 'horizontal', scaleID: 'y', value: 0, borderColor: 'black', borderWidth: 2}];
                renderPriceChart(myShortTermChart, shortTermPriceChartCtx, datasets, annotations, '단기 주가 추이 (뉴스 기간 기준 %)');
            }
            
            
            function renderPriceChart(chartInstance, context, datasets, annotations, titleText) {
                if (chartInstance) {
                    chartInstance.destroy();
                }
                if (!context) return;

                const newChart = new Chart(context, {
                    type: 'line',
                    data: { datasets: datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: { display: true, text: titleText },
                            tooltip: { mode: 'index', intersect: false, callbacks: { label: ctx => `${ctx.dataset.label || ''}: ${ctx.parsed.y.toFixed(2)}%` } },
                            annotation: { annotations: annotations }
                        },
                        scales: {
                            x: { type: 'time', time: { unit: 'day', tooltipFormat: 'yyyy-MM-dd' } },
                            y: { title: { display: true, text: '가격 변화율 (%)' }, ticks: { callback: value => value + '%' } }
                        }
                    }
                });

                // 수정된 부분: myChart 대신 올바른 변수에 할당합니다.
                if (context === longTermPriceChartCtx) {
                    myLongTermChart = newChart;
                } else if (context === shortTermPriceChartCtx) {
                    myShortTermChart = newChart;
                }
            }

            function destroyCharts() {
                if (myLongTermChart) { myLongTermChart.destroy(); myLongTermChart = null; }
                if (myShortTermChart) { myShortTermChart.destroy(); myShortTermChart = null; }
            }

            closeAnalysisButton.addEventListener('click', function() {
                analysisOutputContainer.style.display = 'none';
                resultsDiv.innerHTML = '';
                newsListDisplay.innerHTML = '<p>뉴스를 분석 중입니다...</p>';
                marketDataVisualizationSection.style.display = 'none';
                tickerChartGrid.innerHTML = '';
                document.getElementById('stockSelect').value = '';
                document.getElementById('otherStockSelect').value = '';
                destroyCharts(); // 수정된 부분: myChart 관련 코드를 제거하고 이 함수만 호출
            });

            // startAnalysis 함수 수정: 포트폴리오 또는 다른 주식 드롭다운에서 선택된 티커를 처리
            window.startAnalysis = function() {
                const stockSelect = document.getElementById('stockSelect');
                const otherStockSelect = document.getElementById('otherStockSelect');
            
                let tickerToAnalyze = stockSelect.value || otherStockSelect.value;
            
                if (!tickerToAnalyze) {
                    showError('분석할 주식을 선택하세요!');
                    return;
                }
            
                hideError();
                destroyCharts(); // 수정된 부분: myChart 관련 코드를 모두 제거하고 이 함수만 남김
                
                resultsDiv.innerHTML = '';
                newsListDisplay.innerHTML = '<p>뉴스를 분석 중입니다...</p>';
                analysisOutputContainer.style.display = 'none';
                marketDataVisualizationSection.style.display = 'none';
                tickerChartGrid.innerHTML = '';
            
                loadingDiv.style.display = 'flex';
                loadingMessage.textContent = '분석 준비 중...';
                loadingExplanation.textContent = explanations['분석 준비 중...'] || '';
            
                stockSelect.value = '';
                otherStockSelect.value = '';
            
                socket.emit('start_analysis_request', { ticker: tickerToAnalyze });
            }
            
            
        }); // DOMContentLoaded 끝
    </script>
</body>
</html>